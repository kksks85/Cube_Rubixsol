{% extends "base.html" %}
{% set active_page = "uav_service" %}

{% block title %}Diagnosis & Work Order - {{ incident.incident_number_formatted }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0 text-gray-800">Diagnosis & Work Order</h1>
                <a href="{{ url_for('uav_service.view_incident', id=incident.id) }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Incident
                </a>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        Step 2: Diagnosis & Work Order - {{ incident.incident_number_formatted }}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-primary">UAV Information</h6>
                            <p><strong>Model:</strong> {{ incident.uav_model }}</p>
                            <p><strong>Serial Number:</strong> {{ incident.uav_serial_number or 'N/A' }}</p>
                            <p><strong>Flight Hours:</strong> {{ incident.flight_hours or 'Unknown' }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">Issue Description</h6>
                            <p><strong>Category:</strong> {{ incident.incident_category.replace('_', ' ').title() }}</p>
                            <p><strong>Description:</strong> {{ incident.description }}</p>
                        </div>
                    </div>

                    <form method="POST">
                        {{ form.hidden_tag() }}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.diagnostic_findings.label(class="form-label") }}
                                    {{ form.diagnostic_findings(class="form-control", rows="6") }}
                                    {% if form.diagnostic_findings.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.diagnostic_findings.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    {{ form.work_order_type.label(class="form-label") }}
                                    {{ form.work_order_type(class="form-control") }}
                                    {% if form.work_order_type.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.work_order_type.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    {{ form.estimated_cost.label(class="form-label") }}
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        {{ form.estimated_cost(class="form-control") }}
                                    </div>
                                    <small class="form-text text-muted">Estimated cost for repair/maintenance</small>
                                </div>

                                <div class="mb-3">
                                    {{ form.technician_notes.label(class="form-label") }}
                                    {{ form.technician_notes(class="form-control", rows="6") }}
                                    <small class="form-text text-muted">Additional notes and recommendations</small>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <!-- Assignment Section -->
                                <div class="border rounded p-3 mb-3 bg-light">
                                    <h6 class="text-primary mb-3"><i class="fas fa-users me-2"></i>Assignment</h6>
                                    
                                    <div class="mb-3">
                                        {{ form.assignment_group_id.label(class="form-label") }}
                                        {{ form.assignment_group_id(class="form-control", id="assignment-group-select") }}
                                        <small class="form-text text-muted">
                                            <a href="javascript:void(0)" onclick="viewAllGroups()" class="text-primary">
                                                <i class="fas fa-external-link-alt"></i> View All Groups
                                            </a>
                                        </small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        {{ form.assigned_to_id.label(class="form-label") }}
                                        {{ form.assigned_to_id(class="form-control", id="assigned-user-select") }}
                                        <small class="form-text text-muted">Select user after choosing assignment group</small>
                                    </div>
                                </div>

                                <!-- Work Order Type Explanation -->
                                <div class="border rounded p-3 mb-3 bg-info bg-opacity-10">
                                    <h6 class="text-info mb-2"><i class="fas fa-info-circle me-2"></i>Work Order Types</h6>
                                    <ul class="small mb-0">
                                        <li><strong>REPAIR:</strong> Fix identified issues</li>
                                        <li><strong>REPLACE:</strong> Component replacement needed</li>
                                        <li><strong>MAINTENANCE:</strong> Preventive maintenance</li>
                                        <li><strong>INSPECTION:</strong> Detailed inspection only</li>
                                        <li><strong>CALIBRATION:</strong> System calibration</li>
                                    </ul>
                                </div>

                                <!-- Priority Indicators -->
                                <div class="border rounded p-3 mb-3">
                                    <h6 class="text-warning mb-2"><i class="fas fa-exclamation-triangle me-2"></i>Priority Level</h6>
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <span class="badge bg-danger fs-6">High</span>
                                            <small class="d-block">Critical</small>
                                        </div>
                                        <div class="col-4">
                                            <span class="badge bg-warning fs-6">Medium</span>
                                            <small class="d-block">Standard</small>
                                        </div>
                                        <div class="col-4">
                                            <span class="badge bg-success fs-6">Low</span>
                                            <small class="d-block">Routine</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Multiple Parts Request System -->
                        <div class="card shadow mb-4">
                            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                                <h6 class="m-0 font-weight-bold text-primary">Parts Request List</h6>
                                <button type="button" class="btn btn-success btn-sm" id="add-part-btn" onclick="showAddPartModal()">
                                    <i class="fas fa-plus"></i> Add Part
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover" id="parts-request-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 25%">Part Number</th>
                                                <th style="width: 35%">Part Name</th>
                                                <th style="width: 15%">Category</th>
                                                <th style="width: 10%">Quantity</th>
                                                <th style="width: 10%">In Stock</th>
                                                <th style="width: 5%">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="parts-request-tbody">
                                            <tr id="no-parts-row">
                                                <td colspan="6" class="text-center text-muted">
                                                    <i class="fas fa-info-circle"></i> No parts requested yet. Click "Add Part" to add parts to this work order.
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Hidden input to store parts data for form submission -->
                                <input type="hidden" name="requested_parts_data" id="requested-parts-data" value="">
                                
                                <div class="mt-3 p-3 bg-light rounded">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <small class="text-muted">
                                                <i class="fas fa-lightbulb text-warning"></i>
                                                <strong>Tip:</strong> Add all required parts for this service. The system will check stock availability and create proper inventory requests.
                                            </small>
                                        </div>
                                        <div class="col-md-6 text-end">
                                            <span class="badge bg-info">Total Parts: <span id="parts-count">0</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Add Part Modal -->
                        <div class="modal fade" id="addPartModal" tabindex="-1" aria-labelledby="addPartModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="addPartModalLabel">
                                            <i class="fas fa-plus-circle text-success"></i> Add Part to Request
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="add-part-form">
                                            <div class="row">
                                                <div class="col-12 mb-3">
                                                    <label class="form-label">Select Part</label>
                                                    <select class="form-control" id="modal-part-select" onchange="populatePartDetails()">
                                                        <option value="">-- Select Part for {{ incident.uav_model }} --</option>
                                                    </select>
                                                    <small class="form-text text-muted">Parts filtered for {{ incident.uav_model }} model</small>
                                                </div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Part Number</label>
                                                    <input type="text" class="form-control" id="modal-part-number" readonly>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Part Name</label>
                                                    <input type="text" class="form-control" id="modal-part-name" readonly>
                                                </div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label">Category</label>
                                                    <input type="text" class="form-control" id="modal-part-category" readonly>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label">In Stock</label>
                                                    <input type="text" class="form-control" id="modal-part-stock" readonly>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label">Quantity Needed *</label>
                                                    <input type="number" class="form-control" id="modal-quantity" min="1" value="1" required>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Notes (Optional)</label>
                                                <textarea class="form-control" id="modal-part-notes" rows="2" placeholder="Any specific notes for this part..."></textarea>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="button" class="btn btn-success" onclick="addPartToTable()">
                                            <i class="fas fa-check"></i> Add Part
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Diagnostic Checklist -->
                        <div class="mt-4">
                            <h6 class="text-primary">Diagnostic Checklist</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="check1">
                                        <label class="form-check-label" for="check1">Visual inspection completed</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="check2">
                                        <label class="form-check-label" for="check2">System diagnostics run</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="check3">
                                        <label class="form-check-label" for="check3">Component testing performed</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="check4">
                                        <label class="form-check-label" for="check4">Flight controller checked</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="check5">
                                        <label class="form-check-label" for="check5">Communication systems tested</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="check6">
                                        <label class="form-check-label" for="check6">Documentation updated</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 d-flex justify-content-between">
                            <a href="{{ url_for('uav_service.view_incident', id=incident.id) }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Incident
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-check"></i> Complete Diagnosis & Create Work Order
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Assignment Group and User Selection
    const assignmentGroupSelect = document.getElementById('assignment-group-select');
    const assignedUserSelect = document.getElementById('assigned-user-select');

    assignmentGroupSelect.addEventListener('change', function() {
        const groupId = this.value;
        
        // Clear user selection
        assignedUserSelect.innerHTML = '<option value="">-- Select User --</option>';
        
        if (groupId) {
            // Fetch users for this assignment group
            fetch(`/uav-service/api/assignment-group-users/${groupId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.users && data.users.length > 0) {
                        data.users.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = `${user.full_name} (${user.username})`;
                            if (user.is_leader) {
                                option.textContent += ' [Lead]';
                            }
                            assignedUserSelect.appendChild(option);
                        });
                    } else {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'No users available in this group';
                        assignedUserSelect.appendChild(option);
                    }
                })
                .catch(error => {
                    console.error('Error loading assignment group users:', error);
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Error loading users';
                    assignedUserSelect.appendChild(option);
                });
        }
    });

    function viewAllGroups() {
        // Open assignment groups page in new tab
        window.open('/users/assignment-groups', '_blank');
    }

    // Multiple Parts System Functions
    let requestedParts = [];

    // Show add part modal and populate parts dropdown
    window.showAddPartModal = function() {
        // Load compatible parts in modal dropdown
        loadModalParts();
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('addPartModal'));
        modal.show();
    }

    // Load parts for modal dropdown
    function loadModalParts() {
        const uavModel = '{{ incident.uav_model }}';
        const modalPartSelect = document.getElementById('modal-part-select');
        
        console.log('Loading parts for modal dropdown:', uavModel);
        
        modalPartSelect.innerHTML = '<option value="">Loading parts...</option>';
        
        fetch(`/uav-service/api/compatible-parts?uav_model=${encodeURIComponent(uavModel)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.parts.length > 0) {
                    let html = '<option value="">-- Select Part for {{ incident.uav_model }} --</option>';
                    data.parts.forEach(part => {
                        html += `
                            <option value="${part.id}" 
                                    data-part-number="${part.part_number}"
                                    data-part-name="${part.name}"
                                    data-part-category="${part.category_name || 'Uncategorized'}"
                                    data-part-stock="${part.quantity_in_stock}"
                                    data-part-manufacturer="${part.manufacturer || 'N/A'}"
                                    data-part-cost="${part.unit_cost || '0.00'}">
                                [${part.category_name || 'Uncategorized'}] ${part.part_number} - ${part.name}
                            </option>
                        `;
                    });
                    modalPartSelect.innerHTML = html;
                } else {
                    modalPartSelect.innerHTML = '<option value="">No compatible parts found</option>';
                }
            })
            .catch(error => {
                console.error('Error loading modal parts:', error);
                modalPartSelect.innerHTML = '<option value="">Error loading parts</option>';
            });
    }

    // Populate part details in modal when part is selected
    window.populatePartDetails = function() {
        const selectedOption = document.getElementById('modal-part-select').options[document.getElementById('modal-part-select').selectedIndex];
        
        if (selectedOption.value) {
            document.getElementById('modal-part-number').value = selectedOption.dataset.partNumber || '';
            document.getElementById('modal-part-name').value = selectedOption.dataset.partName || '';
            document.getElementById('modal-part-category').value = selectedOption.dataset.partCategory || '';
            document.getElementById('modal-part-stock').value = (selectedOption.dataset.partStock || '0') + ' units';
            
            // Set focus to quantity field
            document.getElementById('modal-quantity').focus();
        } else {
            // Clear fields if no part selected
            document.getElementById('modal-part-number').value = '';
            document.getElementById('modal-part-name').value = '';
            document.getElementById('modal-part-category').value = '';
            document.getElementById('modal-part-stock').value = '';
        }
    }

    // Add part to the table
    window.addPartToTable = function() {
        const partSelect = document.getElementById('modal-part-select');
        const selectedOption = partSelect.options[partSelect.selectedIndex];
        const quantity = document.getElementById('modal-quantity').value;
        const notes = document.getElementById('modal-part-notes').value;

        // Validation
        if (!selectedOption.value) {
            alert('Please select a part');
            return;
        }
        
        if (!quantity || quantity < 1) {
            alert('Please enter a valid quantity');
            return;
        }

        // Check if part already exists in the table
        const existingPart = requestedParts.find(part => part.id === selectedOption.value);
        if (existingPart) {
            alert('This part is already in the request list. You can edit the quantity in the table.');
            return;
        }

        // Create part object
        const partData = {
            id: selectedOption.value,
            partNumber: selectedOption.dataset.partNumber,
            partName: selectedOption.dataset.partName,
            category: selectedOption.dataset.partCategory,
            stock: selectedOption.dataset.partStock,
            manufacturer: selectedOption.dataset.partManufacturer,
            cost: selectedOption.dataset.partCost,
            quantity: parseInt(quantity),
            notes: notes
        };

        // Add to requestedParts array
        requestedParts.push(partData);
        
        // Update table
        updatePartsTable();
        
        // Update hidden form data
        updateFormData();
        
        // Clear modal and close
        clearModalForm();
        bootstrap.Modal.getInstance(document.getElementById('addPartModal')).hide();
    }

    // Update the parts table
    function updatePartsTable() {
        const tbody = document.getElementById('parts-request-tbody');
        const noPartsRow = document.getElementById('no-parts-row');
        
        if (requestedParts.length === 0) {
            noPartsRow.style.display = 'table-row';
        } else {
            noPartsRow.style.display = 'none';
            
            // Clear existing rows (except no-parts-row)
            const existingRows = tbody.querySelectorAll('tr:not(#no-parts-row)');
            existingRows.forEach(row => row.remove());
            
            // Add rows for each requested part
            requestedParts.forEach((part, index) => {
                const stockStatus = getStockStatus(parseInt(part.stock), part.quantity);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${part.partNumber}</strong>
                        ${part.notes ? `<br><small class="text-muted">${part.notes}</small>` : ''}
                    </td>
                    <td>${part.partName}</td>
                    <td>
                        <span class="badge bg-secondary">${part.category}</span>
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm" value="${part.quantity}" 
                               min="1" onchange="updatePartQuantity(${index}, this.value)" style="width: 80px;">
                    </td>
                    <td>
                        <span class="badge ${stockStatus.class}">${part.stock} units</span>
                        ${stockStatus.warning ? `<br><small class="text-warning">${stockStatus.warning}</small>` : ''}
                    </td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removePartFromTable(${index})" title="Remove part">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Update parts count
        document.getElementById('parts-count').textContent = requestedParts.length;
    }

    // Get stock status with appropriate styling
    function getStockStatus(stock, requestedQty) {
        if (stock === 0) {
            return {
                class: 'bg-danger',
                warning: 'Out of stock!'
            };
        } else if (stock < requestedQty) {
            return {
                class: 'bg-warning text-dark',
                warning: 'Insufficient stock!'
            };
        } else if (stock <= 5) {
            return {
                class: 'bg-warning text-dark',
                warning: 'Low stock'
            };
        } else {
            return {
                class: 'bg-success',
                warning: null
            };
        }
    }

    // Update part quantity
    window.updatePartQuantity = function(index, newQuantity) {
        if (newQuantity && newQuantity > 0) {
            requestedParts[index].quantity = parseInt(newQuantity);
            updateFormData();
            updatePartsTable(); // Refresh to update stock warnings
        }
    }

    // Remove part from table
    window.removePartFromTable = function(index) {
        if (confirm('Are you sure you want to remove this part from the request?')) {
            requestedParts.splice(index, 1);
            updatePartsTable();
            updateFormData();
        }
    }

    // Update hidden form data
    function updateFormData() {
        const formData = JSON.stringify(requestedParts);
        document.getElementById('requested-parts-data').value = formData;
    }

    // Clear modal form
    function clearModalForm() {
        document.getElementById('modal-part-select').value = '';
        document.getElementById('modal-part-number').value = '';
        document.getElementById('modal-part-name').value = '';
        document.getElementById('modal-part-category').value = '';
        document.getElementById('modal-part-stock').value = '';
        document.getElementById('modal-quantity').value = '1';
        document.getElementById('modal-part-notes').value = '';
    }
});
</script>
{% endblock %}
