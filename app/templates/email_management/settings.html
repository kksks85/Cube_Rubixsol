{% extends "base.html" %}

{% block content %}
<div class="container-fluid">

    <div class="row">
        <div class="col-lg-8">
            <!-- SMTP Configuration -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-server me-2"></i>SMTP Server Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <form id="smtpConfigForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="smtpServer" class="form-label">SMTP Server</label>
                                    <input type="text" class="form-control" id="smtpServer" value="{{ config.smtp_server }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="smtpPort" class="form-label">SMTP Port</label>
                                    <input type="number" class="form-control" id="smtpPort" value="{{ config.smtp_port }}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="senderEmail" class="form-label">Sender Email</label>
                                    <input type="email" class="form-control" id="senderEmail" value="{{ config.sender_email }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="senderName" class="form-label">Sender Name</label>
                                    <input type="text" class="form-control" id="senderName" value="{{ config.sender_name }}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="smtpUsername" class="form-label">SMTP Username</label>
                                    <input type="text" class="form-control" id="smtpUsername" value="{{ config.smtp_username }}" placeholder="Usually your email address">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="smtpPassword" class="form-label">SMTP Password</label>
                                    <input type="password" class="form-control" id="smtpPassword" value="{{ config.smtp_password }}" placeholder="Your email password or app password">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="useTLS" {% if config.use_tls %}checked{% endif %}>
                                        <label class="form-check-label" for="useTLS">
                                            Use TLS/STARTTLS
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="useSSL">
                                        <label class="form-check-label" for="useSSL">
                                            Use SSL
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Save Configuration
                            </button>
                            <button type="button" class="btn btn-success" onclick="fastSave()">
                                <i class="fas fa-bolt me-2"></i>Fast Save
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="testConnection()">
                                <i class="fas fa-plug me-2"></i>Test Connection
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="testSaveSpeed()">
                                <i class="fas fa-tachometer-alt me-2"></i>Test Save Speed
                            </button>
                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="testPing()">
                                Ping
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="testMinimal()">
                                Minimal
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Common Email Providers -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-mail-bulk me-2"></i>Quick Setup for Common Providers
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card border">
                                <div class="card-body text-center">
                                    <i class="fab fa-google fa-2x text-danger mb-2"></i>
                                    <h6>Gmail</h6>
                                    <button class="btn btn-outline-primary btn-sm" onclick="setupProvider('gmail')">
                                        Quick Setup
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border">
                                <div class="card-body text-center">
                                    <i class="fab fa-microsoft fa-2x text-primary mb-2"></i>
                                    <h6>Outlook/Office 365</h6>
                                    <button class="btn btn-outline-primary btn-sm" onclick="setupProvider('outlook')">
                                        Quick Setup
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border">
                                <div class="card-body text-center">
                                    <i class="fas fa-envelope fa-2x text-info mb-2"></i>
                                    <h6>SendGrid</h6>
                                    <button class="btn btn-outline-primary btn-sm" onclick="setupProvider('sendgrid')">
                                        Quick Setup
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border">
                                <div class="card-body text-center">
                                    <i class="fas fa-mail-bulk fa-2x text-warning mb-2"></i>
                                    <h6>Mailgun</h6>
                                    <button class="btn btn-outline-primary btn-sm" onclick="setupProvider('mailgun')">
                                        Quick Setup
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Connection Status -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-wifi me-2"></i>Connection Status
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3" id="connectionStatus">
                        <div class="flex-shrink-0">
                            <div class="status-indicator bg-secondary" id="statusIndicator"></div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0" id="statusText">Not tested</h6>
                            <small class="text-muted" id="statusDetails">Click 'Test Connection' to verify settings</small>
                        </div>
                    </div>
                    
                    <div class="border-top pt-3">
                        <small class="text-muted">
                            <strong>Last tested:</strong> Never<br>
                            <strong>Last successful:</strong> Never
                        </small>
                    </div>
                </div>
            </div>

            <!-- Test Email -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-envelope-open me-2"></i>Test Email
                    </h6>
                </div>
                <div class="card-body">
                    <form id="testEmailForm">
                        <div class="mb-3">
                            <label for="testEmail" class="form-label">Recipient Email</label>
                            <input type="email" class="form-control" id="testEmail" placeholder="test@example.com" required>
                        </div>
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-paper-plane me-2"></i>Send Test Email
                        </button>
                    </form>
                    <div id="testEmailResult" class="mt-3" style="display: none;"></div>
                </div>
            </div>

            <!-- Security Tips -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="fas fa-shield-alt me-2"></i>Security Tips
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Use app-specific passwords for Gmail
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Enable 2FA on your email account
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Use TLS encryption when possible
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-check text-success me-2"></i>
                            Regularly rotate SMTP passwords
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Help & Documentation -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-question-circle me-2"></i>Need Help?
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="showHelp()">
                            <i class="fas fa-book me-2"></i>Setup Guide
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="showTroubleshooting()">
                            <i class="fas fa-tools me-2"></i>Troubleshooting
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="contactSupport()">
                            <i class="fas fa-headset me-2"></i>Contact Support
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}
</style>

<script>
function setupProvider(provider) {
    const providers = {
        gmail: {
            server: 'smtp.gmail.com',
            port: 587,
            tls: true,
            ssl: false
        },
        outlook: {
            server: 'smtp-mail.outlook.com',
            port: 587,
            tls: true,
            ssl: false
        },
        sendgrid: {
            server: 'smtp.sendgrid.net',
            port: 587,
            tls: true,
            ssl: false
        },
        mailgun: {
            server: 'smtp.mailgun.org',
            port: 587,
            tls: true,
            ssl: false
        }
    };
    
    const config = providers[provider];
    if (config) {
        document.getElementById('smtpServer').value = config.server;
        document.getElementById('smtpPort').value = config.port;
        document.getElementById('useTLS').checked = config.tls;
        document.getElementById('useSSL').checked = config.ssl;
        
        alert(`Configuration for ${provider} has been applied. Please enter your credentials and test the connection.`);
    }
}

function testConnection() {
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const statusDetails = document.getElementById('statusDetails');
    const testBtn = document.querySelector('button[onclick="testConnection()"]');
    
    // Show testing state
    statusIndicator.className = 'status-indicator bg-warning';
    statusText.textContent = 'Testing...';
    statusDetails.textContent = 'Verifying SMTP connection';
    
    // Disable button during test
    const originalText = testBtn.innerHTML;
    testBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
    testBtn.disabled = true;
    
    // Test connection
    fetch('{{ url_for("email_management.test_smtp_connection") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusIndicator.className = 'status-indicator bg-success';
            statusText.textContent = 'Connected';
            statusDetails.textContent = data.details || 'SMTP connection successful';
        } else {
            statusIndicator.className = 'status-indicator bg-danger';
            statusText.textContent = 'Connection Failed';
            statusDetails.textContent = data.details || 'Unable to connect to SMTP server';
        }
    })
    .catch(error => {
        statusIndicator.className = 'status-indicator bg-danger';
        statusText.textContent = 'Connection Failed';
        statusDetails.textContent = 'Network error or server unavailable';
        console.error('Connection test error:', error);
    })
    .finally(() => {
        // Restore button
        testBtn.innerHTML = originalText;
        testBtn.disabled = false;
    });
}

document.getElementById('smtpConfigForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
    submitBtn.disabled = true;
    
    // Collect form data
    const formData = new FormData();
    formData.append('smtp_server', document.getElementById('smtpServer').value);
    formData.append('smtp_port', document.getElementById('smtpPort').value);
    formData.append('sender_email', document.getElementById('senderEmail').value);
    formData.append('sender_name', document.getElementById('senderName').value);
    formData.append('smtp_username', document.getElementById('smtpUsername').value);
    formData.append('smtp_password', document.getElementById('smtpPassword').value);
    if (document.getElementById('useTLS').checked) {
        formData.append('use_tls', 'on');
    }
    
    // Send data to server with fast timeout
    fetch('{{ url_for("email_management.email_settings") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert alert at the top of the form
            const cardBody = this.closest('.card-body');
            cardBody.insertBefore(alertDiv, cardBody.firstChild);
            
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        } else {
            // Show error message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const cardBody = this.closest('.card-body');
            cardBody.insertBefore(alertDiv, cardBody.firstChild);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        alertDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>Network error. Please try again.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const cardBody = this.closest('.card-body');
        cardBody.insertBefore(alertDiv, cardBody.firstChild);
    })
    .finally(() => {
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

function showHelp() {
    alert('Setup guide would be displayed here');
}

function showTroubleshooting() {
    alert('Troubleshooting guide would be displayed here');
}

function contactSupport() {
    alert('Support contact information would be displayed here');
}

// Test Email Form Handler
document.getElementById('testEmailForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    const resultDiv = document.getElementById('testEmailResult');
    const testEmail = document.getElementById('testEmail').value;
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
    submitBtn.disabled = true;
    resultDiv.style.display = 'none';
    
    // Send test email
    const formData = new FormData();
    formData.append('test_email', testEmail);
    
    fetch('{{ url_for("email_management.send_test_email") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        resultDiv.style.display = 'block';
        
        if (data.success) {
            resultDiv.className = 'alert alert-success mt-3';
            resultDiv.innerHTML = `<i class="fas fa-check-circle me-2"></i>${data.message}`;
        } else {
            resultDiv.className = 'alert alert-danger mt-3';
            resultDiv.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${data.message}`;
        }
    })
    .catch(error => {
        resultDiv.style.display = 'block';
        resultDiv.className = 'alert alert-danger mt-3';
        resultDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Failed to send test email. Please try again.';
        console.error('Test email error:', error);
    })
    .finally(() => {
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// Test save speed function
function testSaveSpeed() {
    console.log('Testing save speed...');
    
    const startTime = performance.now();
    
    const formData = new FormData();
    formData.append('smtp_server', 'test.server.com');
    formData.append('smtp_port', '587');
    formData.append('sender_email', 'test@test.com');
    
    fetch('/email_management/test-save', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        const networkTime = performance.now() - startTime;
        console.log('Network round trip time:', networkTime, 'ms');
        return response.json();
    })
    .then(data => {
        const totalTime = performance.now() - startTime;
        console.log('Total test time:', totalTime, 'ms');
        console.log('Server response:', data);
        
        alert(`Save speed test completed!\nNetwork time: ${networkTime.toFixed(1)}ms\nTotal time: ${totalTime.toFixed(1)}ms\nServer message: ${data.message}`);
    })
    .catch(error => {
        console.error('Save speed test failed:', error);
        alert('Save speed test failed: ' + error.message);
    });
}

// Fast save function
function fastSave() {
    const formData = new FormData();
    formData.append('smtp_server', document.getElementById('smtpServer').value);
    formData.append('smtp_port', document.getElementById('smtpPort').value);
    formData.append('sender_email', document.getElementById('senderEmail').value);
    formData.append('sender_name', document.getElementById('senderName').value);
    formData.append('smtp_username', document.getElementById('smtpUsername').value);
    formData.append('smtp_password', document.getElementById('smtpPassword').value);
    if (document.getElementById('useTLS').checked) {
        formData.append('use_tls', 'on');
    }
    
    fetch('/email_management/save-config', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ ' + data.message);
        } else {
            alert('❌ ' + data.message);
        }
    })
    .catch(error => {
        alert('Network error: ' + error.message);
    });
}

// Test ping function
function testPing() {
    const start = performance.now();
    fetch('/email_management/ping', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        const time = performance.now() - start;
        alert(`Ping: ${time.toFixed(1)}ms`);
    })
    .catch(error => alert('Ping failed: ' + error.message));
}

// Test minimal save function
function testMinimal() {
    const start = performance.now();
    fetch('/email_management/minimal-save', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        const time = performance.now() - start;
        alert(`Minimal save: ${time.toFixed(1)}ms`);
    })
    .catch(error => alert('Minimal save failed: ' + error.message));
}
</script>
{% endblock %}
