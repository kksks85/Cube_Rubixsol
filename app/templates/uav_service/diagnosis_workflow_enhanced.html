{% extends "base.html" %}
{% set active_page = "uav_service" %}

{% block title %}Diagnosis & Work Order - {{ incident.incident_number_formatted }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0 text-gray-800">Diagnosis & Work Order</h1>
                <a href="{{ url_for('uav_service.view_incident', id=incident.id) }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Incident
                </a>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        Step 2: Diagnosis & Work Order - {{ incident.incident_number_formatted }}
                    </h6>
                </div>
                <div class="card-body">
                    <!-- UAV Information Summary -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-primary">UAV Information</h6>
                            <p><strong>Model:</strong> {{ incident.uav_model }}</p>
                            <p><strong>Serial Number:</strong> {{ incident.uav_serial_number or 'N/A' }}</p>
                            <p><strong>Flight Hours:</strong> {{ incident.flight_hours or 'Unknown' }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">Issue Description</h6>
                            <p><strong>Category:</strong> {{ incident.incident_category.replace('_', ' ').title() }}</p>
                            <p><strong>Description:</strong> {{ incident.description }}</p>
                        </div>
                    </div>

                    <!-- Form Errors Display -->
                    {% if form.errors %}
                    <div class="alert alert-danger">
                        <h6>Form Validation Errors:</h6>
                        <ul class="mb-0">
                            {% for field_name, errors in form.errors.items() %}
                                {% for error in errors %}
                                    <li><strong>{{ field_name }}:</strong> {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- Main Form -->
                    <form method="POST" id="diagnosis-form">
                        {{ form.hidden_tag() }}
                        <input type="hidden" name="parts_data" id="parts-data" value="">
                        
                        <div class="row">
                            <!-- Left Column -->
                            <div class="col-md-6">
                                <!-- Diagnostic Findings -->
                                <div class="mb-3">
                                    {{ form.diagnostic_findings.label(class="form-label") }}
                                    {{ form.diagnostic_findings(class="form-control", rows="5", placeholder="Describe what you found during the diagnostic process...") }}
                                    <small class="form-text text-muted">Required: Detailed findings from your diagnosis</small>
                                </div>

                                <!-- Work Order Type -->
                                <div class="mb-3">
                                    {{ form.work_order_type.label(class="form-label") }}
                                    {{ form.work_order_type(class="form-control") }}
                                    <small class="form-text text-muted">Select the type of work needed</small>
                                </div>

                                <!-- Estimated Cost -->
                                <div class="mb-3">
                                    {{ form.estimated_cost.label(class="form-label") }}
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        {{ form.estimated_cost(class="form-control", placeholder="0.00") }}
                                    </div>
                                    <small class="form-text text-muted">Estimated cost for repair/maintenance</small>
                                </div>

                                <!-- Technician Notes -->
                                <div class="mb-3">
                                    {{ form.technician_notes.label(class="form-label") }}
                                    {{ form.technician_notes(class="form-control", rows="4", placeholder="Additional notes and recommendations...") }}
                                    <small class="form-text text-muted">Additional notes and recommendations</small>
                                </div>
                            </div>

                            <!-- Right Column -->
                            <div class="col-md-6">
                                <!-- Assignment Section -->
                                <div class="border rounded p-3 mb-3 bg-light">
                                    <h6 class="text-primary mb-3"><i class="fas fa-users me-2"></i>Assignment</h6>
                                    
                                    <div class="mb-3">
                                        {{ form.assignment_group_id.label(class="form-label") }}
                                        {{ form.assignment_group_id(class="form-control") }}
                                        <small class="form-text text-muted">Select assignment group</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        {{ form.assigned_to_id.label(class="form-label") }}
                                        {{ form.assigned_to_id(class="form-control") }}
                                        <small class="form-text text-muted">Select user after choosing assignment group</small>
                                    </div>
                                </div>

                                <!-- Enhanced Parts Required Section -->
                                <div class="border rounded p-3 mb-3">
                                    <h6 class="text-primary mb-3"><i class="fas fa-cogs me-2"></i>Parts Required</h6>
                                    
                                    <div class="form-check mb-3">
                                        <input type="checkbox" class="form-check-input" id="parts-required-checkbox" name="parts_required" value="1">
                                        <label class="form-check-label" for="parts-required-checkbox">
                                            Parts are needed for this repair
                                        </label>
                                    </div>

                                    <!-- Parts Management Section (hidden by default) -->
                                    <div id="parts-management" style="display: none;">
                                        <div class="alert alert-info">
                                            <small><strong>UAV Model:</strong> {{ incident.uav_model }}</small><br>
                                            <small>Only compatible parts for this UAV model will be shown.</small>
                                        </div>
                                        
                                        <!-- Add Part Button -->
                                        <button type="button" class="btn btn-success btn-sm mb-3" id="add-part-btn">
                                            <i class="fas fa-plus"></i> Add Part
                                        </button>
                                        
                                        <!-- Parts List -->
                                        <div id="parts-list">
                                            <div id="no-parts-message" class="text-muted text-center p-3">
                                                <i class="fas fa-info-circle"></i> No parts added yet.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Work Order Types Help -->
                                <div class="border rounded p-3 mb-3 bg-info bg-opacity-10">
                                    <h6 class="text-info mb-2"><i class="fas fa-info-circle me-2"></i>Work Order Types</h6>
                                    <ul class="small mb-0">
                                        <li><strong>REPAIR:</strong> Fix identified issues</li>
                                        <li><strong>REPLACE:</strong> Component replacement needed</li>
                                        <li><strong>MAINTENANCE:</strong> Preventive maintenance</li>
                                        <li><strong>INSPECTION:</strong> Detailed inspection only</li>
                                        <li><strong>CALIBRATION:</strong> System calibration</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Diagnostic Checklist -->
                        <div class="mt-4">
                            <h6 class="text-primary">Diagnostic Checklist</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="check1">
                                        <label class="form-check-label" for="check1">Visual inspection completed</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="check2">
                                        <label class="form-check-label" for="check2">System diagnostics run</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="check3">
                                        <label class="form-check-label" for="check3">Component testing performed</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="check4">
                                        <label class="form-check-label" for="check4">Flight controller checked</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="check5">
                                        <label class="form-check-label" for="check5">Communication systems tested</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="check6">
                                        <label class="form-check-label" for="check6">Documentation updated</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="mt-4 d-flex justify-content-between">
                            <a href="{{ url_for('uav_service.view_incident', id=incident.id) }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Incident
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-check"></i> Complete Diagnosis & Create Work Order
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Part Selection Modal -->
<div class="modal fade" id="partSelectionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Part for {{ incident.uav_model }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Search Parts</label>
                    <input type="text" class="form-control" id="part-search" placeholder="Search by part number or name...">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Select Part</label>
                    <select class="form-control" id="part-select" size="8">
                        <option value="">Loading parts...</option>
                    </select>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="part-quantity" min="1" value="1">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Available Stock</label>
                            <input type="text" class="form-control" id="part-stock" readonly>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" id="part-notes" rows="2" placeholder="Additional notes about this part..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="add-part-confirm">Add Part</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Enhanced diagnosis workflow loaded');
    
    // Global variables
    let availableParts = [];
    let selectedParts = [];
    
    // DOM elements
    const partsCheckbox = document.getElementById('parts-required-checkbox');
    const partsManagement = document.getElementById('parts-management');
    const addPartBtn = document.getElementById('add-part-btn');
    const partsList = document.getElementById('parts-list');
    const noPartsMessage = document.getElementById('no-parts-message');
    const partSelectionModal = new bootstrap.Modal(document.getElementById('partSelectionModal'));
    const partsDataInput = document.getElementById('parts-data');
    
    // Parts required functionality
    if (partsCheckbox && partsManagement) {
        partsCheckbox.addEventListener('change', function() {
            if (this.checked) {
                partsManagement.style.display = 'block';
                loadCompatibleParts();
            } else {
                partsManagement.style.display = 'none';
                selectedParts = [];
                updatePartsDisplay();
                updatePartsData();
            }
        });
    }
    
    // Add part button
    if (addPartBtn) {
        addPartBtn.addEventListener('click', function() {
            partSelectionModal.show();
        });
    }
    
    // Load compatible parts for UAV model
    function loadCompatibleParts() {
        const uavModel = '{{ incident.uav_model }}';
        console.log('Loading parts for UAV model:', uavModel);
        
        fetch(`/uav-service/api/compatible-parts?uav_model=${encodeURIComponent(uavModel)}`)
            .then(response => response.json())
            .then(data => {
                console.log('Parts data received:', data);
                if (data.success) {
                    availableParts = data.parts;
                    populatePartSelect();
                } else {
                    console.error('Error loading parts:', data.message);
                    availableParts = [];
                    populatePartSelect();
                }
            })
            .catch(error => {
                console.error('Error fetching parts:', error);
                availableParts = [];
                populatePartSelect();
            });
    }
    
    // Populate part selection dropdown
    function populatePartSelect() {
        const partSelect = document.getElementById('part-select');
        partSelect.innerHTML = '';
        
        if (availableParts.length === 0) {
            partSelect.innerHTML = '<option value="">No compatible parts found</option>';
            return;
        }
        
        availableParts.forEach(part => {
            const option = document.createElement('option');
            option.value = part.id;
            option.textContent = `${part.part_number} - ${part.name} (Stock: ${part.quantity_in_stock})`;
            option.dataset.partNumber = part.part_number;
            option.dataset.partName = part.name;
            option.dataset.stock = part.quantity_in_stock;
            option.dataset.unitCost = part.unit_cost;
            partSelect.appendChild(option);
        });
        
        // Add change event listener
        partSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                document.getElementById('part-stock').value = `${selectedOption.dataset.stock} units`;
            } else {
                document.getElementById('part-stock').value = '';
            }
        });
    }
    
    // Search functionality
    document.getElementById('part-search').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const partSelect = document.getElementById('part-select');
        
        // Clear current options
        partSelect.innerHTML = '';
        
        // Filter and display matching parts
        const filteredParts = availableParts.filter(part => 
            part.part_number.toLowerCase().includes(searchTerm) ||
            part.name.toLowerCase().includes(searchTerm)
        );
        
        if (filteredParts.length === 0) {
            partSelect.innerHTML = '<option value="">No matching parts found</option>';
            return;
        }
        
        filteredParts.forEach(part => {
            const option = document.createElement('option');
            option.value = part.id;
            option.textContent = `${part.part_number} - ${part.name} (Stock: ${part.quantity_in_stock})`;
            option.dataset.partNumber = part.part_number;
            option.dataset.partName = part.name;
            option.dataset.stock = part.quantity_in_stock;
            option.dataset.unitCost = part.unit_cost;
            partSelect.appendChild(option);
        });
    });
    
    // Add part confirmation
    document.getElementById('add-part-confirm').addEventListener('click', function() {
        const partSelect = document.getElementById('part-select');
        const selectedOption = partSelect.options[partSelect.selectedIndex];
        const quantity = parseInt(document.getElementById('part-quantity').value);
        const notes = document.getElementById('part-notes').value;
        
        if (!selectedOption.value) {
            alert('Please select a part');
            return;
        }
        
        if (!quantity || quantity < 1) {
            alert('Please enter a valid quantity');
            return;
        }
        
        const stock = parseInt(selectedOption.dataset.stock);
        if (quantity > stock) {
            alert(`Insufficient stock. Available: ${stock}, Requested: ${quantity}`);
            return;
        }
        
        // Check if part already selected
        if (selectedParts.find(p => p.part_id === selectedOption.value)) {
            alert('This part is already added to the list');
            return;
        }
        
        // Add part to selected list
        const partData = {
            part_id: selectedOption.value,
            part_number: selectedOption.dataset.partNumber,
            part_name: selectedOption.dataset.partName,
            quantity: quantity,
            stock: stock,
            unit_cost: parseFloat(selectedOption.dataset.unitCost),
            notes: notes
        };
        
        selectedParts.push(partData);
        updatePartsDisplay();
        updatePartsData();
        
        // Reset modal
        partSelect.selectedIndex = 0;
        document.getElementById('part-quantity').value = '1';
        document.getElementById('part-notes').value = '';
        document.getElementById('part-stock').value = '';
        
        partSelectionModal.hide();
    });
    
    // Update parts display
    function updatePartsDisplay() {
        if (selectedParts.length === 0) {
            noPartsMessage.style.display = 'block';
            partsList.innerHTML = '<div id="no-parts-message" class="text-muted text-center p-3"><i class="fas fa-info-circle"></i> No parts added yet.</div>';
            return;
        }
        
        noPartsMessage.style.display = 'none';
        
        let html = '';
        selectedParts.forEach((part, index) => {
            const stockStatus = part.quantity > part.stock ? 'danger' : (part.stock <= 5 ? 'warning' : 'success');
            
            html += `
                <div class="card mb-2">
                    <div class="card-body p-3">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <strong>${part.part_number}</strong><br>
                                <small class="text-muted">${part.part_name}</small>
                            </div>
                            <div class="col-md-2">
                                <input type="number" class="form-control form-control-sm" value="${part.quantity}" min="1" onchange="updatePartQuantity(${index}, this.value)">
                            </div>
                            <div class="col-md-2">
                                <span class="badge bg-${stockStatus}">${part.stock} in stock</span>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">${part.notes || 'No notes'}</small>
                            </div>
                            <div class="col-md-2 text-end">
                                <button type="button" class="btn btn-danger btn-sm" onclick="removePart(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        partsList.innerHTML = html;
    }
    
    // Update parts data for form submission
    function updatePartsData() {
        partsDataInput.value = JSON.stringify(selectedParts);
    }
    
    // Global functions for inline event handlers
    window.updatePartQuantity = function(index, newQuantity) {
        const quantity = parseInt(newQuantity);
        if (quantity && quantity > 0) {
            selectedParts[index].quantity = quantity;
            updatePartsData();
            updatePartsDisplay();
        }
    };
    
    window.removePart = function(index) {
        if (confirm('Are you sure you want to remove this part?')) {
            selectedParts.splice(index, 1);
            updatePartsDisplay();
            updatePartsData();
        }
    };
    
    // Form validation
    const form = document.getElementById('diagnosis-form');
    form.addEventListener('submit', function(e) {
        const diagnosticFindings = document.querySelector('textarea[name="diagnostic_findings"]');
        const workOrderType = document.querySelector('select[name="work_order_type"]');
        
        let hasErrors = false;
        let errorMsg = 'Please complete the following required fields:\n\n';
        
        if (!diagnosticFindings.value.trim()) {
            hasErrors = true;
            errorMsg += '- Diagnostic Findings\n';
            diagnosticFindings.classList.add('is-invalid');
        } else {
            diagnosticFindings.classList.remove('is-invalid');
        }
        
        if (!workOrderType.value) {
            hasErrors = true;
            errorMsg += '- Work Order Type\n';
            workOrderType.classList.add('is-invalid');
        } else {
            workOrderType.classList.remove('is-invalid');
        }
        
        // Check if parts are required but none added
        if (partsCheckbox.checked && selectedParts.length === 0) {
            hasErrors = true;
            errorMsg += '- At least one part is required when "Parts are needed" is checked\n';
        }
        
        if (hasErrors) {
            e.preventDefault();
            alert(errorMsg);
            return false;
        }
        
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    });
});
</script>

<style>
.is-invalid {
    border-color: #dc3545 !important;
}

#part-select {
    height: 200px;
}

.card-body p {
    margin-bottom: 0.5rem;
}
</style>
{% endblock %}
