{% extends "base.html" %}
{% set active_page = "uav_service" %}

{% block title %}Edit Stages - UAV Service Incident {{ incident.incident_number_formatted }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0 text-gray-800">
                    <i class="fas fa-edit me-2"></i>Edit Workflow Stages
                </h1>
                <a href="{{ url_for('uav_service.view_incident', id=incident.id) }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Incident
                </a>
            </div>

            <!-- Incident Summary -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-info-circle me-2"></i>Incident Summary
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Incident Number:</strong> {{ incident.incident_number_formatted }}<br>
                            <strong>Title:</strong> {{ incident.title }}<br>
                        </div>
                        <div class="col-md-6">
                            <strong>Current Status:</strong> 
                            <span class="badge badge-primary">{{ incident.workflow_status.replace('_', ' ').title() }}</span><br>
                            <strong>Customer:</strong> {{ incident.customer_name }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current Progress -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-success">
                        <i class="fas fa-route me-2"></i>Current Workflow Progress
                    </h6>
                </div>
                <div class="card-body">
                    <div class="progress mb-3" style="height: 25px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: {{ incident.workflow_progress_percentage }}%"
                             aria-valuenow="{{ incident.workflow_progress_percentage }}" 
                             aria-valuemin="0" aria-valuemax="100">
                            Step {{ incident.workflow_step_info.step }}/6 - {{ incident.workflow_progress_percentage|round|int }}%
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stage Navigation -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-warning">
                        <i class="fas fa-navigation me-2"></i>Navigate to Workflow Stage
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-shield-alt me-2"></i>
                        <strong>Data Preservation Guarantee:</strong> 
                        When you navigate to any workflow stage, ALL existing data will be preserved and pre-populated in the forms. 
                        You can safely edit any stage without losing previously entered information.
                    </div>

                    <form method="POST">
                        <div class="row">
                            {% for stage in workflow_stages %}
                            <div class="col-md-4 mb-3">
                                <div class="card stage-card 
                                    {% if incident.workflow_status == stage.key %}
                                        border-primary bg-primary bg-opacity-10
                                    {% elif incident.workflow_step_info.step > stage.step %}
                                        border-success bg-success bg-opacity-10
                                    {% else %}
                                        border-light
                                    {% endif %}">
                                    <div class="card-body text-center">
                                        <div class="stage-icon mb-3">
                                            <i class="{{ stage.icon }} fa-2x 
                                                {% if incident.workflow_status == stage.key %}
                                                    text-primary
                                                {% elif incident.workflow_step_info.step > stage.step %}
                                                    text-success
                                                {% else %}
                                                    text-muted
                                                {% endif %}"></i>
                                        </div>
                                        <h6 class="card-title">
                                            Step {{ stage.step }}: {{ stage.name }}
                                        </h6>
                                        <p class="card-text text-muted small">
                                            {{ stage.description }}
                                        </p>
                                        
                                        {% if incident.workflow_status == stage.key %}
                                            <span class="badge badge-primary">Current Stage</span>
                                        {% elif incident.workflow_step_info.step > stage.step %}
                                            <span class="badge badge-success">Completed</span>
                                        {% else %}
                                            <span class="badge badge-light">Pending</span>
                                        {% endif %}
                                        
                                        <div class="mt-3">
                                            <button type="submit" 
                                                    name="selected_stage" 
                                                    value="{{ stage.key }}"
                                                    class="btn 
                                                        {% if incident.workflow_status == stage.key %}
                                                            btn-primary
                                                        {% elif incident.workflow_step_info.step > stage.step %}
                                                            btn-success
                                                        {% else %}
                                                            btn-outline-primary
                                                        {% endif %} btn-sm">
                                                <i class="fas fa-edit me-1"></i>
                                                {% if incident.workflow_status == stage.key %}
                                                    Edit Current Stage
                                                {% else %}
                                                    Navigate & Edit
                                                {% endif %}
                                            </button>
                                        </div>
                                        
                                        <!-- Data preservation indicator -->
                                        <div class="mt-2">
                                            <small class="text-success">
                                                <i class="fas fa-database me-1"></i>Data Preserved
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </form>
                </div>
            </div>

            <!-- Data Preservation Notice -->
            <div class="card shadow border-success">
                <div class="card-header bg-success bg-opacity-10 py-3">
                    <h6 class="m-0 font-weight-bold text-success">
                        <i class="fas fa-shield-alt me-2"></i>Data Preservation Guarantee
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-success">üõ°Ô∏è Safe Navigation:</h6>
                            <ul class="text-muted">
                                <li>All existing form data is automatically preserved</li>
                                <li>Previously entered information will be pre-populated</li>
                                <li>No data loss when switching between stages</li>
                                <li>Forms show current values from the database</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success">üìã What's Preserved:</h6>
                            <ul class="text-muted">
                                <li>Diagnostic findings and technician notes</li>
                                <li>Work order assignments and parts information</li>
                                <li>Quality check results and certifications</li>
                                <li>Maintenance schedules and service records</li>
                            </ul>
                        </div>
                    </div>
                    <div class="alert alert-success mt-3 mb-0">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Guarantee:</strong> You can safely navigate to any stage without fear of losing existing data. 
                        All forms will be pre-populated with current values from the database.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.stage-card {
    transition: all 0.3s ease;
    cursor: pointer;
    min-height: 220px;
}

.stage-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

.stage-icon {
    margin-bottom: 15px;
}

.card-title {
    font-size: 1rem;
    margin-bottom: 10px;
}

.card-text {
    font-size: 0.875rem;
    line-height: 1.4;
}

.btn-sm {
    font-size: 0.8rem;
    padding: 0.375rem 0.75rem;
}

/* Progress bar styling */
.progress {
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

/* Badge styling */
.badge {
    font-size: 0.75rem;
    padding: 0.375rem 0.5rem;
}

/* Alert styling */
.alert {
    border-left: 4px solid;
}

.alert-info {
    border-left-color: #17a2b8;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .stage-card {
        min-height: 180px;
        margin-bottom: 1rem;
    }
    
    .stage-icon i {
        font-size: 1.5rem !important;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add click handler to stage cards (excluding the button area)
    const stageCards = document.querySelectorAll('.stage-card');
    
    stageCards.forEach(card => {
        card.addEventListener('click', function(e) {
            // Don't trigger if clicking on the button
            if (!e.target.closest('button')) {
                const button = card.querySelector('button[type="submit"]');
                if (button) {
                    button.click();
                }
            }
        });
    });
    
    // Add confirmation for navigation to future stages
    const buttons = document.querySelectorAll('button[name="selected_stage"]');
    
    buttons.forEach(button => {
        button.addEventListener('click', function(e) {
            const currentStep = {{ incident.workflow_step_info.step }};
            const selectedStage = this.value;
            const stageSteps = {
                'INCIDENT_RAISED': 1,
                'DIAGNOSIS_WO': 2,
                'REPAIR_MAINTENANCE': 3,
                'QUALITY_CHECK': 4,
                'PREVENTIVE_MAINTENANCE': 5,
                'CLOSED': 6
            };
            
            const selectedStep = stageSteps[selectedStage];
            
            if (selectedStep > currentStep) {
                const confirmed = confirm(
                    `You are navigating to a future stage (Step ${selectedStep}) while currently at Step ${currentStep}. ` +
                    `This may skip intermediate workflow steps. Are you sure you want to continue?`
                );
                
                if (!confirmed) {
                    e.preventDefault();
                }
            }
        });
    });
});
</script>
{% endblock %}
