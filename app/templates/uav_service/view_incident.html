{% extends "base.html" %}
{% set active_page = "uav_service" %}

{% block title %}UAV Service Incident {{ incident.incident_number_formatted }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0 text-gray-800">UAV Service Incident {{ incident.incident_number_formatted }}</h1>
                <a href="{{ url_for('uav_service.incident_list') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to List
                </a>
            </div>

            <!-- Workflow Progress Bar -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Service Workflow Progress</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12">
                            <div class="progress mb-3" style="height: 25px;">
                                <div class="progress-bar bg-success" role="progressbar" 
                                     style="width: {{ incident.workflow_progress_percentage }}%"
                                     aria-valuenow="{{ incident.workflow_progress_percentage }}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                    Step {{ incident.workflow_step_info.step }}/6 - {{ incident.workflow_progress_percentage|round|int }}%
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 6-Step Workflow Indicators -->
                    <div class="row text-center">
                        <div class="col">
                            <div class="workflow-step {{ 'active' if incident.workflow_step_info.step >= 1 else '' }}">
                                <div class="step-circle {{ 'bg-success text-white' if incident.workflow_step_info.step >= 1 else 'bg-light' }}">1</div>
                                <div class="step-label">Incident/Service Request</div>
                                <small class="text-muted">Customer reports issue</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="workflow-step {{ 'active' if incident.workflow_step_info.step >= 2 else '' }}">
                                <div class="step-circle {{ 'bg-success text-white' if incident.workflow_step_info.step >= 2 else 'bg-light' }}">2</div>
                                <div class="step-label">Diagnosis & Work Order</div>
                                <small class="text-muted">Technician diagnosis</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="workflow-step {{ 'active' if incident.workflow_step_info.step >= 3 else '' }}">
                                <div class="step-circle {{ 'bg-success text-white' if incident.workflow_step_info.step >= 3 else 'bg-light' }}">3</div>
                                <div class="step-label">Repair/Maintenance</div>
                                <small class="text-muted">Parts & technician work</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="workflow-step {{ 'active' if incident.workflow_step_info.step >= 4 else '' }}">
                                <div class="step-circle {{ 'bg-success text-white' if incident.workflow_step_info.step >= 4 else 'bg-light' }}">4</div>
                                <div class="step-label">Quality Check & Handover</div>
                                <small class="text-muted">QA & compliance</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="workflow-step {{ 'active' if incident.workflow_step_info.step >= 5 else '' }}">
                                <div class="step-circle {{ 'bg-success text-white' if incident.workflow_step_info.step >= 5 else 'bg-light' }}">5</div>
                                <div class="step-label">Preventive Maintenance</div>
                                <small class="text-muted">Schedule future maintenance</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="workflow-step {{ 'active' if incident.workflow_step_info.step >= 6 else '' }}">
                                <div class="step-circle {{ 'bg-success text-white' if incident.workflow_step_info.step >= 6 else 'bg-light' }}">6</div>
                                <div class="step-label">Closed</div>
                                <small class="text-muted">Service completed</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Step Actions -->
                    <div class="mt-4">
                        {% if incident.workflow_status == 'INCIDENT_RAISED' %}
                            <a href="{{ url_for('uav_service.diagnosis_workflow', id=incident.id) }}" class="btn btn-primary">
                                <i class="fas fa-stethoscope"></i> Start Diagnosis
                            </a>
                        {% elif incident.workflow_status == 'DIAGNOSIS_WO' %}
                            <a href="{{ url_for('uav_service.repair_maintenance_workflow', id=incident.id) }}" class="btn btn-primary">
                                <i class="fas fa-tools"></i> Start Repair/Maintenance
                            </a>
                        {% elif incident.workflow_status == 'REPAIR_MAINTENANCE' %}
                            <a href="{{ url_for('uav_service.quality_check_workflow', id=incident.id) }}" class="btn btn-primary">
                                <i class="fas fa-check-circle"></i> Quality Check
                            </a>
                        {% elif incident.workflow_status == 'QUALITY_CHECK' %}
                            <a href="{{ url_for('uav_service.preventive_maintenance_workflow', id=incident.id) }}" class="btn btn-primary">
                                <i class="fas fa-calendar-alt"></i> Setup Preventive Maintenance
                            </a>
                        {% elif incident.workflow_status == 'PREVENTIVE_MAINTENANCE' %}
                            <a href="{{ url_for('uav_service.close_incident_workflow', id=incident.id) }}" class="btn btn-success">
                                <i class="fas fa-flag-checkered"></i> Close Incident
                            </a>
                        {% elif incident.workflow_status == 'CLOSED' %}
                            <div class="alert alert-success mb-0">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>Service Completed!</strong> This incident has been closed.
                                {% if incident.closed_at %}
                                    <br><small class="text-muted">Closed on {{ incident.closed_at.strftime('%B %d, %Y at %I:%M %p') }}</small>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Incident Details -->
                <div class="col-md-8">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Incident Details</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Title:</strong><br>
                                    {{ incident.title }}<br><br>
                                    
                                    <strong>Description:</strong><br>
                                    {{ incident.description }}<br><br>
                                    
                                    <strong>Category:</strong><br>
                                    <span class="badge badge-info">{{ incident.incident_category.replace('_', ' ').title() }}</span><br><br>
                                    
                                    <strong>Priority:</strong><br>
                                    {% if incident.priority == 'URGENT' %}
                                        <span class="badge badge-danger">{{ incident.priority }}</span>
                                    {% elif incident.priority == 'HIGH' %}
                                        <span class="badge badge-warning">{{ incident.priority }}</span>
                                    {% elif incident.priority == 'MEDIUM' %}
                                        <span class="badge badge-primary">{{ incident.priority }}</span>
                                    {% else %}
                                        <span class="badge badge-secondary">{{ incident.priority }}</span>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <strong>Serial Number:</strong><br>
                                    {{ incident.serial_number if incident.serial_number else 'Not specified' }}<br><br>
                                    
                                    <strong>Product Name:</strong><br>
                                    {{ incident.product_name if incident.product_name else 'Not specified' }}<br><br>
                                    
                                    <strong>Owner Company:</strong><br>
                                    {{ incident.owner_company if incident.owner_company else 'Not specified' }}<br><br>
                                    
                                    {% if incident.last_service_date %}
                                    <strong>Last Service Date:</strong><br>
                                    {{ incident.last_service_date.strftime('%Y-%m-%d') }}<br><br>
                                    {% endif %}
                                    
                                    <strong>Warranty Service:</strong><br>
                                    {% if incident.is_warranty_service %}
                                        <span class="badge badge-success">Yes</span>
                                    {% else %}
                                        <span class="badge badge-warning">No</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Information -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Customer Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Name:</strong><br>
                                    {{ incident.customer_name }}<br><br>
                                    
                                    {% if incident.customer_email %}
                                    <strong>Email:</strong><br>
                                    <a href="mailto:{{ incident.customer_email }}">{{ incident.customer_email }}</a><br><br>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    {% if incident.customer_phone %}
                                    <strong>Phone:</strong><br>
                                    <a href="tel:{{ incident.customer_phone }}">{{ incident.customer_phone }}</a><br><br>
                                    {% endif %}
                                    
                                    {% if incident.customer_address %}
                                    <strong>Address:</strong><br>
                                    {{ incident.customer_address }}<br><br>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Log -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Activity Log</h6>
                        </div>
                        <div class="card-body">
                            {% if activities %}
                                {% for activity in activities %}
                                <div class="d-flex mb-3">
                                    <div class="flex-shrink-0">
                                        <div class="bg-primary rounded-circle p-2 text-white" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-user fa-sm"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <div class="fw-bold">{{ activity.user.username }}</div>
                                        <div class="text-muted small">{{ activity.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</div>
                                        <div class="mt-1">{{ activity.description }}</div>
                                        <span class="badge badge-secondary">{{ activity.activity_type.replace('_', ' ').title() }}</span>
                                    </div>
                                </div>
                                {% if not loop.last %}<hr>{% endif %}
                                {% endfor %}
                            {% else %}
                                <p class="text-muted">No activities recorded yet.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-md-4">
                    <!-- Status Card -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Status Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <strong>Current Status:</strong><br>
                                <span class="badge badge-primary">{{ incident.workflow_step_info.name }}</span>
                            </div>
                            
                            <div class="mb-3">
                                <strong>SLA Status:</strong><br>
                                {% if incident.sla_status == 'BREACHED' %}
                                    <span class="badge badge-danger">SLA Breached</span>
                                {% elif incident.sla_status == 'CRITICAL' %}
                                    <span class="badge badge-warning">Critical</span>
                                {% elif incident.sla_status == 'WARNING' %}
                                    <span class="badge badge-info">Warning</span>
                                {% else %}
                                    <span class="badge badge-success">On Track</span>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <strong>SLA Category:</strong><br>
                                {{ incident.sla_category }} ({{ incident.sla_resolution_hours }}h resolution)
                            </div>
                            
                            <div class="mb-3">
                                <strong>Created:</strong><br>
                                {{ incident.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                            </div>
                            
                            {% if incident.technician %}
                            <div class="mb-3">
                                <strong>Assigned Technician:</strong><br>
                                {{ incident.technician.username }}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Available Inventory Section -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Available Inventory</h6>
                        </div>
                        <div class="card-body">
                            {% if inventory_items %}
                                <div class="text-muted small mb-2">
                                    Compatible parts for: <strong>{{ incident.product_name or incident.uav_model or 'Unknown Model' }}</strong>
                                </div>
                                
                                <!-- Inventory Items List -->
                                <div class="inventory-list" style="max-height: 300px; overflow-y: auto;">
                                    {% for item in inventory_items %}
                                    <div class="inventory-item border-bottom py-2">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <div class="font-weight-bold text-sm">{{ item.name }}</div>
                                                <div class="text-muted small">
                                                    Part #: {{ item.part_number }}
                                                    {% if item.manufacturer %}
                                                        | {{ item.manufacturer }}
                                                    {% endif %}
                                                </div>
                                                {% if item.description %}
                                                <div class="text-muted small">{{ item.description[:100] }}{% if item.description|length > 100 %}...{% endif %}</div>
                                                {% endif %}
                                            </div>
                                            <div class="text-right ml-2">
                                                <div class="font-weight-bold text-sm">
                                                    {{ item.quantity_in_stock }} units
                                                </div>
                                                <div>
                                                    {% if item.stock_status == 'Out of Stock' %}
                                                        <span class="badge badge-danger">{{ item.stock_status }}</span>
                                                    {% elif item.stock_status == 'Low Stock' %}
                                                        <span class="badge badge-warning">{{ item.stock_status }}</span>
                                                    {% elif item.stock_status == 'Overstock' %}
                                                        <span class="badge badge-info">{{ item.stock_status }}</span>
                                                    {% else %}
                                                        <span class="badge badge-success">{{ item.stock_status }}</span>
                                                    {% endif %}
                                                </div>
                                                {% if item.unit_cost %}
                                                <div class="text-muted small">${{ "%.2f"|format(item.unit_cost) }}/unit</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <div class="mt-3 text-center">
                                    <a href="{{ url_for('inventory.items') }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-boxes"></i> View Full Inventory
                                    </a>
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-box-open fa-2x mb-2"></i>
                                    <div>No compatible inventory items found</div>
                                    <div class="small">Or product model not specified</div>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Technical Details -->
                    {% if incident.diagnostic_findings or incident.technician_notes %}
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Technical Details</h6>
                        </div>
                        <div class="card-body">
                            {% if incident.diagnostic_findings %}
                            <div class="mb-3">
                                <strong>Diagnostic Findings:</strong><br>
                                {{ incident.diagnostic_findings }}
                            </div>
                            {% endif %}
                            
                            {% if incident.technician_notes %}
                            <div class="mb-3">
                                <strong>Technician Notes:</strong><br>
                                {{ incident.technician_notes }}
                            </div>
                            {% endif %}
                            
                            {% if incident.technician_hours %}
                            <div class="mb-3">
                                <strong>Hours Worked:</strong><br>
                                {{ incident.technician_hours }} hours
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Cost Information -->
                    {% if incident.estimated_cost or incident.actual_cost %}
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Cost Information</h6>
                        </div>
                        <div class="card-body">
                            {% if incident.estimated_cost %}
                            <div class="mb-3">
                                <strong>Estimated Cost:</strong><br>
                                ${{ "%.2f"|format(incident.estimated_cost|float) }}
                            </div>
                            {% endif %}
                            
                            {% if incident.actual_cost %}
                            <div class="mb-3">
                                <strong>Actual Cost:</strong><br>
                                ${{ "%.2f"|format(incident.actual_cost|float) }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.workflow-step {
    text-align: center;
    padding: 10px;
}

.step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px auto;
    font-weight: bold;
    border: 2px solid #dee2e6;
}

.step-label {
    font-weight: bold;
    margin-bottom: 5px;
    font-size: 0.9em;
}

.workflow-step.active .step-label {
    color: #28a745;
}

.ms-3 {
    margin-left: 1rem;
}
</style>
{% endblock %}
