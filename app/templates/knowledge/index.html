{% extends "base_new.html" %}

{% block title %}Knowledge Base - {{ config.COMPANY_NAME }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Knowledge Base Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="h3 mb-2">
                                <i class="fas fa-book-open me-2"></i>
                                Knowledge Base
                            </h1>
                            <p class="mb-0 opacity-75">
                                Your comprehensive resource for solutions, procedures, and best practices
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-flex gap-2 justify-content-end">
                                <a href="{{ url_for('knowledge.create_article') }}" class="btn btn-light">
                                    <i class="fas fa-plus me-1"></i> New Article
                                </a>
                                <a href="{{ url_for('knowledge.search') }}" class="btn btn-outline-light">
                                    <i class="fas fa-search me-1"></i> Advanced Search
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Search -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form action="{{ url_for('knowledge.search') }}" method="GET" class="d-flex gap-2">
                        <div class="flex-grow-1">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" name="query" class="form-control form-control-lg" 
                                       placeholder="Search articles, solutions, and procedures..." 
                                       autocomplete="off" id="searchInput">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg px-4">Search</button>
                    </form>
                    <!-- Search suggestions dropdown -->
                    <div id="searchSuggestions" class="list-group position-absolute w-100 mt-1 d-none" style="z-index: 1000;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center border-0 bg-light">
                <div class="card-body">
                    <div class="text-primary mb-2">
                        <i class="fas fa-file-alt fa-2x"></i>
                    </div>
                    <h4 class="mb-1">{{ user_stats.total_articles }}</h4>
                    <small class="text-muted">Total Articles</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-0 bg-light">
                <div class="card-body">
                    <div class="text-success mb-2">
                        <i class="fas fa-user-edit fa-2x"></i>
                    </div>
                    <h4 class="mb-1">{{ user_stats.my_articles }}</h4>
                    <small class="text-muted">My Articles</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-0 bg-light">
                <div class="card-body">
                    <div class="text-warning mb-2">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                    <h4 class="mb-1">{{ user_stats.pending_review }}</h4>
                    <small class="text-muted">Pending Review</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-0 bg-light">
                <div class="card-body">
                    <div class="text-info mb-2">
                        <i class="fas fa-bell fa-2x"></i>
                    </div>
                    <h4 class="mb-1">{{ user_stats.subscriptions }}</h4>
                    <small class="text-muted">Subscriptions</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Categories -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-folder text-primary me-2"></i>
                        Categories
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for category in categories %}
                        <a href="{{ url_for('knowledge.view_category', id=category.id) }}" 
                           class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                {% if category.icon %}
                                <i class="{{ category.icon }} me-2" style="color: {{ category.color or '#007bff' }}"></i>
                                {% endif %}
                                <div>
                                    <div class="fw-medium">{{ category.name }}</div>
                                    {% if category.description %}
                                    <small class="text-muted">{{ category.description[:60] }}{% if category.description|length > 60 %}...{% endif %}</small>
                                    {% endif %}
                                </div>
                            </div>
                            <span class="badge bg-secondary rounded-pill">{{ category.article_count }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <a href="{{ url_for('knowledge.list_categories') }}" class="btn btn-sm btn-outline-primary w-100">
                        <i class="fas fa-th-list me-1"></i> View All Categories
                    </a>
                </div>
            </div>
        </div>

        <!-- Recent Articles -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock text-success me-2"></i>
                        Recent Articles
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for article in recent_articles %}
                        <a href="{{ url_for('knowledge.view_article', id=article.id) }}" 
                           class="list-group-item list-group-item-action">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="fw-medium mb-1">{{ article.title }}</div>
                                    <p class="mb-1 text-muted small">{{ article.summary[:80] }}{% if article.summary|length > 80 %}...{% endif %}</p>
                                    <small class="text-muted">
                                        <span class="badge bg-{{ 'primary' if article.article_type.value == 'SOLUTION' else 'info' if article.article_type.value == 'PROCEDURE' else 'warning' }} me-1">
                                            {{ article.article_type.value.replace('_', ' ').title() }}
                                        </span>
                                        {{ article.created_at.strftime('%m/%d/%Y') }}
                                    </small>
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <a href="{{ url_for('knowledge.list_articles') }}" class="btn btn-sm btn-outline-success w-100">
                        <i class="fas fa-list me-1"></i> View All Articles
                    </a>
                </div>
            </div>
        </div>

        <!-- Popular Articles -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-fire text-danger me-2"></i>
                        Popular Articles
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for article in popular_articles %}
                        <a href="{{ url_for('knowledge.view_article', id=article.id) }}" 
                           class="list-group-item list-group-item-action">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="fw-medium mb-1">{{ article.title }}</div>
                                    <p class="mb-1 text-muted small">{{ article.summary[:80] }}{% if article.summary|length > 80 %}...{% endif %}</p>
                                    <small class="text-muted">
                                        <i class="fas fa-eye me-1"></i>{{ article.view_count }} views
                                        {% if article.average_rating > 0 %}
                                        <span class="ms-2">
                                            <i class="fas fa-star text-warning me-1"></i>{{ "%.1f"|format(article.average_rating) }}
                                        </span>
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <a href="{{ url_for('knowledge.search', sort_by='view_count') }}" class="btn btn-sm btn-outline-danger w-100">
                        <i class="fas fa-chart-line me-1"></i> View Most Popular
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt text-warning me-2"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('knowledge.create_article') }}" class="btn btn-outline-primary w-100">
                                <i class="fas fa-plus me-2"></i>Create Article
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('knowledge.my_articles') }}" class="btn btn-outline-success w-100">
                                <i class="fas fa-user-edit me-2"></i>My Articles
                            </a>
                        </div>
                        {% if current_user.has_role('knowledge_reviewer') or current_user.has_role('knowledge_admin') or current_user.has_role('admin') %}
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('knowledge.pending_review') }}" class="btn btn-outline-warning w-100">
                                <i class="fas fa-clock me-2"></i>Pending Review
                            </a>
                        </div>
                        {% endif %}
                        {% if current_user.has_role('knowledge_admin') or current_user.has_role('admin') %}
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('knowledge.analytics') }}" class="btn btn-outline-info w-100">
                                <i class="fas fa-chart-bar me-2"></i>Analytics
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search Suggestions Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const suggestionsContainer = document.getElementById('searchSuggestions');
    let timeout;

    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(timeout);
        
        if (query.length < 2) {
            suggestionsContainer.classList.add('d-none');
            return;
        }

        timeout = setTimeout(() => {
            fetch(`{{ url_for('knowledge.search_suggestions') }}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(suggestions => {
                    suggestionsContainer.innerHTML = '';
                    
                    if (suggestions.length > 0) {
                        suggestions.forEach(suggestion => {
                            const item = document.createElement('a');
                            item.className = 'list-group-item list-group-item-action';
                            item.href = suggestion.url;
                            
                            const icon = suggestion.type === 'article' ? 'fa-file-alt' : 
                                        suggestion.type === 'category' ? 'fa-folder' : 'fa-tag';
                            
                            item.innerHTML = `
                                <i class="fas ${icon} me-2 text-muted"></i>
                                ${suggestion.title}
                                <small class="text-muted ms-2">(${suggestion.type})</small>
                            `;
                            
                            suggestionsContainer.appendChild(item);
                        });
                        suggestionsContainer.classList.remove('d-none');
                    } else {
                        suggestionsContainer.classList.add('d-none');
                    }
                })
                .catch(() => {
                    suggestionsContainer.classList.add('d-none');
                });
        }, 300);
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
            suggestionsContainer.classList.add('d-none');
        }
    });
});
</script>
{% endblock %}
