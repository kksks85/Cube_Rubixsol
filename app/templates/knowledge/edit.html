{% extends "base_new.html" %}

{% block title %}Edit Article - Knowledge Base{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ url_for('knowledge.index') }}">
                    <i class="fas fa-book-open me-1"></i>Knowledge Base
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('knowledge.my_articles') }}">My Articles</a>
            </li>
            <li class="breadcrumb-item active">Edit Article</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 bg-gradient-warning text-dark">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="h3 mb-2">
                                <i class="fas fa-edit me-2"></i>
                                Edit Article
                            </h1>
                            <p class="mb-0 opacity-75">
                                Update your knowledge article
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <a href="{{ url_for('knowledge.view_article', id=article.id) }}" class="btn btn-outline-dark">
                                <i class="fas fa-eye me-1"></i> View Article
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Form -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-edit me-2"></i>Article Details
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data">
                        {{ form.hidden_tag() }}
                        
                        {% if form.errors %}
                        <div class="alert alert-danger">
                            <h6>Please correct the following errors:</h6>
                            <ul class="mb-0">
                                {% for field, errors in form.errors.items() %}
                                    {% for error in errors %}
                                    <li>{{ field }}: {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <div class="row">
                            <!-- Left Column -->
                            <div class="col-md-8">
                                <!-- Title -->
                                <div class="mb-3">
                                    {{ form.title.label(class="form-label fw-medium") }}
                                    {{ form.title(class="form-control") }}
                                </div>

                                <!-- Summary -->
                                <div class="mb-3">
                                    {{ form.summary.label(class="form-label fw-medium") }}
                                    {{ form.summary(class="form-control") }}
                                    <div class="form-text">Brief description of the article (max 500 characters)</div>
                                </div>

                                <!-- Content -->
                                <div class="mb-3">
                                    {{ form.content.label(class="form-label fw-medium") }}
                                    {{ form.content(class="form-control", rows="15") }}
                                    <div class="form-text">Main article content (supports Markdown)</div>
                                </div>

                                <!-- Tags -->
                                <div class="mb-3">
                                    {{ form.tags.label(class="form-label fw-medium") }}
                                    {{ form.tags(class="form-control") }}
                                    <div class="form-text">Enter tags separated by commas</div>
                                </div>
                            </div>

                            <!-- Right Column -->
                            <div class="col-md-4">
                                <!-- Article Type -->
                                <div class="mb-3">
                                    {{ form.article_type.label(class="form-label fw-medium") }}
                                    {{ form.article_type(class="form-select") }}
                                </div>

                                <!-- Category -->
                                <div class="mb-3">
                                    {{ form.category_id.label(class="form-label fw-medium") }}
                                    {{ form.category_id(class="form-select") }}
                                </div>

                                <!-- Subcategory -->
                                <div class="mb-3">
                                    {{ form.subcategory_id.label(class="form-label fw-medium") }}
                                    {{ form.subcategory_id(class="form-select") }}
                                </div>

                                <!-- Visibility -->
                                <div class="mb-3">
                                    {{ form.visibility.label(class="form-label fw-medium") }}
                                    {{ form.visibility(class="form-select") }}
                                </div>

                                <!-- Priority -->
                                <div class="mb-3">
                                    {{ form.priority.label(class="form-label fw-medium") }}
                                    {{ form.priority(class="form-select") }}
                                </div>

                                <!-- Status -->
                                {% if current_user.role and (current_user.role.name in ['knowledge_reviewer', 'knowledge_admin'] or current_user.role.name == 'admin') %}
                                <div class="mb-3">
                                    {{ form.status.label(class="form-label fw-medium") }}
                                    {{ form.status(class="form-select") }}
                                </div>
                                {% endif %}

                                <!-- Featured -->
                                {% if current_user.role and (current_user.role.name in ['knowledge_admin'] or current_user.role.name == 'admin') %}
                                <div class="mb-3">
                                    <div class="form-check">
                                        {{ form.is_featured(class="form-check-input") }}
                                        {{ form.is_featured.label(class="form-check-label") }}
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Resolution -->
                                <div class="mb-3">
                                    {{ form.resolution.label(class="form-label fw-medium") }}
                                    {{ form.resolution(class="form-control", rows="4") }}
                                    <div class="form-text">Quick resolution or solution summary</div>
                                </div>

                                <!-- Keywords -->
                                <div class="mb-3">
                                    {{ form.keywords.label(class="form-label fw-medium") }}
                                    {{ form.keywords(class="form-control") }}
                                    <div class="form-text">SEO keywords separated by commas</div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <a href="{{ url_for('knowledge.view_article', id=article.id) }}" class="btn btn-outline-secondary">
                                            <i class="fas fa-times me-1"></i> Cancel
                                        </a>
                                    </div>
                                    <div>
                                        <button type="submit" name="action" value="save_draft" class="btn btn-outline-primary me-2">
                                            <i class="fas fa-save me-1"></i> Save Draft
                                        </button>
                                        {% if current_user.role and (current_user.role.name in ['knowledge_reviewer', 'knowledge_admin'] or current_user.role.name == 'admin') %}
                                        <button type="submit" name="action" value="publish" class="btn btn-success">
                                            <i class="fas fa-check me-1"></i> Update & Publish
                                        </button>
                                        {% else %}
                                        <button type="submit" name="action" value="submit_review" class="btn btn-primary">
                                            <i class="fas fa-paper-plane me-1"></i> Submit for Review
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Article History -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>Article History
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">
                                <strong>Created:</strong> 
                                {{ article.created_at.strftime('%B %d, %Y at %I:%M %p') if article.created_at else 'Unknown' }}
                                {% if article.author %}by {{ article.author.username }}{% endif %}
                            </small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">
                                <strong>Last Updated:</strong> 
                                {{ article.updated_at.strftime('%B %d, %Y at %I:%M %p') if article.updated_at else 'Never' }}
                            </small>
                        </div>
                    </div>
                    {% if article.kb_id %}
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <small class="text-muted">
                                <strong>KB ID:</strong> {{ article.kb_id }}
                            </small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">
                                <strong>Views:</strong> {{ article.view_count or 0 }}
                            </small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Dynamic subcategory loading
document.getElementById('category_id').addEventListener('change', function() {
    const categoryId = this.value;
    const subcategorySelect = document.getElementById('subcategory_id');
    
    // Clear existing options
    subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
    
    if (categoryId) {
        fetch(`/knowledge/api/subcategories/${categoryId}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(subcategory => {
                    const option = document.createElement('option');
                    option.value = subcategory.id;
                    option.textContent = subcategory.name;
                    subcategorySelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error loading subcategories:', error));
    }
});
</script>
{% endblock %}
