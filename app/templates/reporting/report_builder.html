{% extends "base.html" %}

{% block title %}Report Builder - {{ report.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-chart-bar text-primary me-2"></i>
                Report Builder
            </h1>
            <p class="text-muted mb-0">{{ report.name }}</p>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-success" id="saveReportBtn">
                <i class="fas fa-save me-2"></i>Save
            </button>
            <button type="button" class="btn btn-primary" id="executeReportBtn">
                <i class="fas fa-play me-2"></i>Execute
            </button>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-download me-2"></i>Export
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="exportReport('csv')">
                        <i class="fas fa-file-csv me-2"></i>CSV
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportReport('excel')">
                        <i class="fas fa-file-excel me-2"></i>Excel
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportReport('pdf')">
                        <i class="fas fa-file-pdf me-2"></i>PDF
                    </a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Configuration Panel -->
        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Data Source</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="dataSourceSelect" class="form-label">Select Table</label>
                        <select class="form-select" id="dataSourceSelect" onchange="selectDataSource()">
                            <option value="">Choose a table...</option>
                            {% for table_name, table_info in available_tables.items() %}
                            <option value="{{ table_name }}" 
                                    {% if report.data_source == table_name %}selected{% endif %}>
                                {{ table_info.display_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div id="columnSelection" style="display: none;">
                        <label class="form-label">Select Columns</label>
                        <div id="columnCheckboxes" class="max-h-200 overflow-auto border p-2 rounded">
                            <!-- Columns will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters Panel -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Filters</h6>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addFilter()">
                        <i class="fas fa-plus"></i> Add Filter
                    </button>
                </div>
                <div class="card-body">
                    <div id="filtersContainer">
                        <!-- Filters will be added dynamically -->
                    </div>
                </div>
            </div>

            <!-- Visualization Panel -->
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Visualizations</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="chartType" class="form-label">Chart Type</label>
                        <select class="form-select" id="chartType">
                            <option value="">Table Only</option>
                            <option value="bar">Bar Chart</option>
                            <option value="line">Line Chart</option>
                            <option value="pie">Pie Chart</option>
                            <option value="scatter">Scatter Plot</option>
                        </select>
                    </div>
                    
                    <div id="chartOptions" style="display: none;">
                        <div class="mb-3">
                            <label for="xAxis" class="form-label">X-Axis</label>
                            <select class="form-select" id="xAxis">
                                <option value="">Select field...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="yAxis" class="form-label">Y-Axis</label>
                            <select class="form-select" id="yAxis">
                                <option value="">Select field...</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Results</h6>
                    <div id="recordCount" class="text-muted"></div>
                </div>
                <div class="card-body">
                    <div id="loadingIndicator" style="display: none;" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Executing report...</p>
                    </div>
                    
                    <div id="resultsContainer">
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-table fa-3x mb-3"></i>
                            <p>Configure your report and click "Execute" to see results</p>
                        </div>
                    </div>
                    
                    <div id="chartContainer" style="display: none;">
                        <canvas id="reportChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize report configuration safely
let reportConfig = {};
try {
    reportConfig = {
        data_source: "{{ report.data_source or '' }}",
        columns: JSON.parse('{{ (report.columns or "[]") | safe }}') || ['*'],
        filters: JSON.parse('{{ (report.filters or "[]") | safe }}') || [],
        visualizations: JSON.parse('{{ (report.visualizations or "{}") | safe }}') || {}
    };
    console.log('Initial report config loaded:', reportConfig);
} catch (e) {
    console.error('Error initializing report config:', e);
    reportConfig = {
        data_source: '',
        columns: ['*'],
        filters: [],
        visualizations: {}
    };
}

let availableColumns = [];
let currentChart = null;

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    if (reportConfig.data_source) {
        loadTableColumns(reportConfig.data_source);
    }
    
    // Load existing filters
    reportConfig.filters.forEach(filter => {
        addFilter(filter);
    });
    
    // Setup chart type change handler
    document.getElementById('chartType').addEventListener('change', handleChartTypeChange);
});

function selectDataSource() {
    const select = document.getElementById('dataSourceSelect');
    const tableName = select.value;
    
    reportConfig.data_source = tableName;
    
    if (tableName) {
        loadTableColumns(tableName);
    } else {
        document.getElementById('columnSelection').style.display = 'none';
    }
}

function loadTableColumns(tableName) {
    fetch(`/reporting/api/tables/${tableName}/columns`)
        .then(response => response.json())
        .then(columns => {
            availableColumns = columns;
            displayColumnSelection(columns);
            updateAxisOptions(columns);
            document.getElementById('columnSelection').style.display = 'block';
        })
        .catch(error => {
            console.error('Error loading columns:', error);
            alert('Error loading table columns');
        });
}

function displayColumnSelection(columns) {
    const container = document.getElementById('columnCheckboxes');
    container.innerHTML = '';
    
    // Add "Select All" option
    const selectAllDiv = document.createElement('div');
    selectAllDiv.className = 'form-check';
    selectAllDiv.innerHTML = `
        <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
        <label class="form-check-label fw-bold" for="selectAll">
            Select All
        </label>
    `;
    container.appendChild(selectAllDiv);
    
    // Add column checkboxes
    columns.forEach(column => {
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
            <input class="form-check-input column-checkbox" type="checkbox" 
                   id="col_${column.name}" value="${column.name}" 
                   ${reportConfig.columns.includes(column.name) || reportConfig.columns.includes('*') ? 'checked' : ''}>
            <label class="form-check-label" for="col_${column.name}">
                ${column.display_name} <small class="text-muted">(${column.type})</small>
            </label>
        `;
        container.appendChild(div);
    });
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.column-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateSelectedColumns();
}

function updateSelectedColumns() {
    const checkboxes = document.querySelectorAll('.column-checkbox:checked');
    reportConfig.columns = Array.from(checkboxes).map(cb => cb.value);
    
    if (reportConfig.columns.length === 0) {
        reportConfig.columns = ['*'];
    }
}

function addFilter(existingFilter = null) {
    console.log('addFilter called', existingFilter);
    
    const container = document.getElementById('filtersContainer');
    const dataSource = document.getElementById('dataSourceSelect').value;
    
    console.log('Data source:', dataSource);
    console.log('Available columns:', availableColumns);
    
    // Check if data source is selected
    if (!dataSource) {
        alert('Please select a data source first before adding filters.');
        return;
    }
    
    const filterId = 'filter_' + Date.now();
    
    const filterDiv = document.createElement('div');
    filterDiv.className = 'filter-item border rounded p-3 mb-3';
    filterDiv.id = filterId;
    
    try {
        filterDiv.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Field</label>
                    <select class="form-select filter-field" onchange="updateFilter('${filterId}')">
                        <option value="">Select field...</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Operator</label>
                    <select class="form-select filter-operator" onchange="updateFilter('${filterId}')">
                        <option value="equals">Equals</option>
                        <option value="not_equals">Not Equals</option>
                        <option value="contains">Contains</option>
                        <option value="starts_with">Starts With</option>
                        <option value="ends_with">Ends With</option>
                        <option value="greater_than">Greater Than</option>
                        <option value="less_than">Less Than</option>
                        <option value="is_null">Is Null</option>
                        <option value="is_not_null">Is Not Null</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Value</label>
                    <input type="text" class="form-control filter-value" onchange="updateFilter('${filterId}')">
                </div>
                <div class="col-md-1">
                    <label class="form-label">&nbsp;</label>
                    <button type="button" class="btn btn-danger btn-sm d-block" onclick="removeFilter('${filterId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(filterDiv);
        console.log('Filter div added to container');
        
        // Populate field options
        if (availableColumns && availableColumns.length > 0) {
            const fieldSelect = filterDiv.querySelector('.filter-field');
            availableColumns.forEach(column => {
                const option = document.createElement('option');
                option.value = column.name;
                option.textContent = column.display_name;
                fieldSelect.appendChild(option);
            });
            console.log('Field options populated');
        } else {
            // If no columns available, try to load them
            console.log('Loading table columns for:', dataSource);
            loadTableColumns(dataSource);
        }
        
        // Set existing filter values
        if (existingFilter) {
            filterDiv.querySelector('.filter-field').value = existingFilter.field || '';
            filterDiv.querySelector('.filter-operator').value = existingFilter.operator || 'equals';
            filterDiv.querySelector('.filter-value').value = existingFilter.value || '';
            console.log('Existing filter values set');
        }
        
    } catch (error) {
        console.error('Error in addFilter:', error);
        alert('Error adding filter: ' + error.message);
    }
}

function removeFilter(filterId) {
    document.getElementById(filterId).remove();
    updateFilters();
}

function updateFilter(filterId) {
    updateFilters();
}

function updateFilters() {
    const filterItems = document.querySelectorAll('.filter-item');
    reportConfig.filters = [];
    
    filterItems.forEach(item => {
        const field = item.querySelector('.filter-field').value;
        const operator = item.querySelector('.filter-operator').value;
        const value = item.querySelector('.filter-value').value;
        
        if (field && operator) {
            reportConfig.filters.push({ field, operator, value });
        }
    });
}

function executeReport() {
    document.getElementById('loadingIndicator').style.display = 'block';
    document.getElementById('resultsContainer').innerHTML = '';
    
    // Update columns before execution
    updateSelectedColumns();
    
    console.log('Executing report with config:', reportConfig);
    
    // Validate configuration
    if (!reportConfig.data_source) {
        document.getElementById('loadingIndicator').style.display = 'none';
        displayError('Please select a data source first');
        return;
    }
    
    fetch(`/reporting/api/reports/{{ report.id }}/execute`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(reportConfig)
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return response.json();
    })
    .then(result => {
        document.getElementById('loadingIndicator').style.display = 'none';
        console.log('Execution result:', result);
        
        if (result.success) {
            displayResults(result);
        } else {
            displayError(result.error || 'Unknown error occurred');
        }
    })
    .catch(error => {
        document.getElementById('loadingIndicator').style.display = 'none';
        console.error('Detailed error:', error);
        displayError(`Network error occurred: ${error.message}`);
    });
}

function displayResults(result) {
    const container = document.getElementById('resultsContainer');
    const recordCount = document.getElementById('recordCount');
    
    recordCount.textContent = `${result.row_count} records`;
    
    if (result.data.length === 0) {
        container.innerHTML = '<div class="text-center py-4 text-muted">No data found</div>';
        return;
    }
    
    // Create table
    let html = '<div class="table-responsive"><table class="table table-striped table-hover">';
    html += '<thead class="table-dark"><tr>';
    
    result.columns.forEach(col => {
        html += `<th>${col.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</th>`;
    });
    html += '</tr></thead><tbody>';
    
    result.data.slice(0, 100).forEach(row => { // Limit to 100 rows for display
        html += '<tr>';
        result.columns.forEach(col => {
            html += `<td>${row[col] || ''}</td>`;
        });
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    
    if (result.data.length > 100) {
        html += `<div class="text-muted text-center mt-2">Showing first 100 rows of ${result.row_count} total</div>`;
    }
    
    container.innerHTML = html;
    
    // Generate chart if configured
    generateChart(result);
}

function displayError(error) {
    const container = document.getElementById('resultsContainer');
    container.innerHTML = `
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Error:</strong> ${error}
        </div>
    `;
}

function saveReport() {
    updateSelectedColumns();
    updateFilters();
    
    fetch(`/reporting/api/reports/{{ report.id }}/save`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(reportConfig)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Report saved successfully', 'success');
        } else {
            showToast('Error saving report', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error saving report', 'error');
    });
}

function exportReport(format) {
    window.open(`/reporting/reports/{{ report.id }}/export/${format}`, '_blank');
}

function updateAxisOptions(columns) {
    const xAxis = document.getElementById('xAxis');
    const yAxis = document.getElementById('yAxis');
    
    xAxis.innerHTML = '<option value="">Select field...</option>';
    yAxis.innerHTML = '<option value="">Select field...</option>';
    
    columns.forEach(column => {
        const option = document.createElement('option');
        option.value = column.name;
        option.textContent = column.display_name;
        xAxis.appendChild(option.cloneNode(true));
        yAxis.appendChild(option);
    });
}

function handleChartTypeChange() {
    const chartType = document.getElementById('chartType').value;
    const chartOptions = document.getElementById('chartOptions');
    
    if (chartType) {
        chartOptions.style.display = 'block';
    } else {
        chartOptions.style.display = 'none';
        document.getElementById('chartContainer').style.display = 'none';
    }
}

function generateChart(result) {
    const chartType = document.getElementById('chartType').value;
    
    if (!chartType) {
        document.getElementById('chartContainer').style.display = 'none';
        return;
    }
    
    const xField = document.getElementById('xAxis').value;
    const yField = document.getElementById('yAxis').value;
    
    if (!xField || !yField) {
        return;
    }
    
    // Destroy existing chart
    if (currentChart) {
        currentChart.destroy();
    }
    
    // Prepare data
    const labels = result.data.map(row => row[xField]);
    const data = result.data.map(row => parseFloat(row[yField]) || 0);
    
    const ctx = document.getElementById('reportChart');
    document.getElementById('chartContainer').style.display = 'block';
    
    currentChart = new Chart(ctx, {
        type: chartType,
        data: {
            labels: labels,
            datasets: [{
                label: yField.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()),
                data: data,
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: chartType !== 'pie' ? {
                y: {
                    beginAtZero: true
                }
            } : {}
        }
    });
}

function showToast(message, type) {
    // Simple toast implementation
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Event listeners
document.getElementById('executeReportBtn').addEventListener('click', executeReport);
document.getElementById('saveReportBtn').addEventListener('click', saveReport);
</script>

<style>
.max-h-200 {
    max-height: 200px;
}

.filter-item {
    background-color: #f8f9fa;
}

#reportChart {
    max-height: 400px;
}
</style>
{% endblock %}
