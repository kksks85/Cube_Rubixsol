{% extends "base.html" %}

{% block content %}
<style>
.wizard-container {
    max-width: 1200px;
    margin: 0 auto;
}

.step-indicator {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2rem;
    position: relative;
}

.step-indicator::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 50px;
    right: 50px;
    height: 2px;
    background: #e9ecef;
    z-index: 1;
}

.step {
    background: white;
    border: 3px solid #e9ecef;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #6c757d;
    z-index: 2;
    position: relative;
    cursor: pointer;
    transition: all 0.3s;
}

.step.active {
    border-color: #007bff;
    color: #007bff;
    background: #fff;
    transform: scale(1.1);
}

.step.completed {
    border-color: #28a745;
    background: #28a745;
    color: white;
}

.step-content {
    display: none;
    animation: fadeIn 0.5s;
}

.step-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.guide-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.template-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.template-card {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 15px;
    padding: 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
}

.template-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: all 0.6s;
}

.template-card:hover {
    border-color: #007bff;
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,123,255,0.1);
}

.template-card:hover::before {
    left: 100%;
}

.template-card.selected {
    border-color: #007bff;
    background: #f8f9ff;
}

.template-icon {
    font-size: 3rem;
    color: #007bff;
    margin-bottom: 1rem;
    display: block;
}

.table-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.table-card {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.table-card:hover {
    border-color: #28a745;
    background: #f8fff8;
}

.table-card.selected {
    border-color: #28a745;
    background: #28a745;
    color: white;
}

.column-picker {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    min-height: 400px;
}

.available-columns, .selected-columns {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 1rem;
}

.selected-columns {
    border-style: dashed;
    border-color: #28a745;
    background: #f8fff8;
}

.column-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem;
    margin: 0.5rem 0;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}

.column-item:hover {
    background: #e3f2fd;
    border-color: #2196f3;
    transform: translateX(5px);
}

.column-item.in-selected {
    background: #d4edda;
    border-color: #28a745;
}

.selected-column-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem;
    margin: 0.5rem 0;
    background: #e8f5e8;
    border: 1px solid #28a745;
    border-radius: 8px;
}

.filter-builder {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 1.5rem;
    margin: 1rem 0;
}

.filter-row {
    display: grid;
    grid-template-columns: 2fr 1fr 2fr auto;
    gap: 1rem;
    align-items: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    margin: 0.5rem 0;
}

.action-buttons {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    display: flex;
    gap: 1rem;
    z-index: 1000;
}

.floating-btn {
    padding: 1rem 2rem;
    border-radius: 50px;
    font-weight: 600;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    border: none;
    transition: all 0.3s;
}

.floating-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}

.btn-next {
    background: linear-gradient(45deg, #007bff, #0056b3);
    color: white;
}

.btn-execute {
    background: linear-gradient(45deg, #28a745, #1e7e34);
    color: white;
}

.progress-indicator {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: #e9ecef;
    z-index: 1001;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #007bff, #28a745);
    width: 0%;
    transition: width 0.5s ease;
}

.results-container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-top: 2rem;
}

.results-header {
    background: linear-gradient(45deg, #28a745, #20c997);
    color: white;
    padding: 1.5rem;
    text-align: center;
}

.help-tooltip {
    position: relative;
    display: inline-block;
    margin-left: 0.5rem;
}

.help-tooltip .tooltip-text {
    visibility: hidden;
    width: 200px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 5px;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    margin-left: -100px;
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 0.8rem;
}

.help-tooltip:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
}

@media (max-width: 768px) {
    .step-indicator::before {
        display: none;
    }
    
    .column-picker {
        grid-template-columns: 1fr;
    }
    
    .template-grid {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        position: relative;
        bottom: auto;
        right: auto;
        justify-content: center;
        margin-top: 2rem;
    }
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-content {
    text-align: center;
    color: white;
}

.loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid #333;
    border-top: 4px solid #fff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <h4>Building Your Report...</h4>
        <p>Please wait while we process your data</p>
    </div>
</div>

<!-- Progress Indicator -->
<div class="progress-indicator">
    <div class="progress-bar" id="progressBar"></div>
</div>

<div class="wizard-container">
    <!-- Header -->
    <div class="guide-card">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h2 mb-2">
                    <i class="fas fa-magic me-2"></i>
                    Smart Report Builder
                </h1>
                <p class="mb-0">Create powerful reports in 4 easy steps. No technical knowledge required!</p>
            </div>
            <div class="col-md-4 text-end">
                <button type="button" class="btn btn-light btn-sm me-2" onclick="showHelp()">
                    <i class="fas fa-question-circle"></i> Help
                </button>
                <button type="button" class="btn btn-outline-light btn-sm" onclick="loadSavedReport()">
                    <i class="fas fa-folder-open"></i> Load Saved
                </button>
            </div>
        </div>
    </div>

    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="step active" id="step-1" onclick="goToStep(1)">1</div>
        <div class="step" id="step-2" onclick="goToStep(2)">2</div>
        <div class="step" id="step-3" onclick="goToStep(3)">3</div>
        <div class="step" id="step-4" onclick="goToStep(4)">4</div>
    </div>

    <!-- Step 1: Choose Template -->
    <div class="step-content active" id="content-1">
        <div class="text-center mb-4">
            <h3><i class="fas fa-rocket text-primary"></i> Step 1: Choose Your Starting Point</h3>
            <p class="text-muted">Select a template to get started quickly, or build from scratch</p>
        </div>

        <div class="template-grid">
            <div class="template-card" onclick="selectTemplate('workorders')">
                <i class="fas fa-clipboard-list template-icon"></i>
                <h5>Work Orders Report</h5>
                <p class="text-muted mb-0">Track work order status, assignments, and completion</p>
                <div class="mt-2">
                    <span class="badge bg-success">Popular</span>
                </div>
            </div>

            <div class="template-card" onclick="selectTemplate('products')">
                <i class="fas fa-cubes template-icon"></i>
                <h5>Product Inventory</h5>
                <p class="text-muted mb-0">Monitor product details, specifications, and status</p>
            </div>

            <div class="template-card" onclick="selectTemplate('users')">
                <i class="fas fa-users template-icon"></i>
                <h5>User Activity Report</h5>
                <p class="text-muted mb-0">Analyze user performance and activity metrics</p>
            </div>

            <div class="template-card" onclick="selectTemplate('custom')">
                <i class="fas fa-cog template-icon"></i>
                <h5>Custom Report</h5>
                <p class="text-muted mb-0">Build your own report from scratch</p>
                <div class="mt-2">
                    <span class="badge bg-info">Advanced</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: Select Data Source -->
    <div class="step-content" id="content-2">
        <div class="text-center mb-4">
            <h3><i class="fas fa-database text-success"></i> Step 2: Choose Your Data Source</h3>
            <p class="text-muted">Select which table contains the main data for your report</p>
        </div>

        <div class="table-grid" id="tableGrid">
            {% for table_name, display_name in available_tables.items() %}
            <div class="table-card" onclick="selectTable('{{ table_name }}', '{{ display_name }}')">
                <i class="fas fa-table mb-2" style="font-size: 2rem; color: #28a745;"></i>
                <h6>{{ display_name }}</h6>
                <small class="text-muted">{{ table_name }}</small>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Step 3: Pick Your Columns -->
    <div class="step-content" id="content-3">
        <div class="text-center mb-4">
            <h3><i class="fas fa-columns text-info"></i> Step 3: Choose What to Show</h3>
            <p class="text-muted">Pick the columns you want to include in your report</p>
        </div>

        <div class="column-picker">
            <div class="available-columns">
                <h5 class="text-center mb-3">
                    <i class="fas fa-list"></i> Available Columns
                    <span class="help-tooltip">
                        <i class="fas fa-info-circle text-info"></i>
                        <span class="tooltip-text">Click on columns to add them to your report</span>
                    </span>
                </h5>
                <div id="availableColumnsList">
                    <p class="text-muted text-center">Select a data source first</p>
                </div>
            </div>

            <div class="selected-columns">
                <h5 class="text-center mb-3">
                    <i class="fas fa-check-square"></i> Selected Columns
                    <span class="help-tooltip">
                        <i class="fas fa-info-circle text-info"></i>
                        <span class="tooltip-text">These columns will appear in your report</span>
                    </span>
                </h5>
                <div id="selectedColumnsList">
                    <p class="text-muted text-center">No columns selected yet</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 4: Add Filters (Optional) -->
    <div class="step-content" id="content-4">
        <div class="text-center mb-4">
            <h3><i class="fas fa-filter text-warning"></i> Step 4: Filter Your Data (Optional)</h3>
            <p class="text-muted">Add filters to show only the data you need</p>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="filter-builder">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="fas fa-sliders-h"></i> Filters</h5>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addFilter()">
                            <i class="fas fa-plus"></i> Add Filter
                        </button>
                    </div>
                    <div id="filtersList">
                        <p class="text-muted text-center py-3">No filters added yet. Click "Add Filter" to get started.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-eye"></i> Live Preview</h6>
                    </div>
                    <div class="card-body">
                        <div id="queryPreview" class="query-preview">
                            <p class="text-muted">Your SQL query will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="results-container" id="resultsContainer" style="display: none;">
        <div class="results-header">
            <h4><i class="fas fa-chart-bar"></i> Your Report Results</h4>
            <p class="mb-0">Report generated successfully!</p>
        </div>
        <div class="p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <span class="badge bg-primary" id="resultCount">0 records</span>
                </div>
                <div>
                    <button type="button" class="btn btn-success btn-sm me-2" onclick="exportResults('csv')">
                        <i class="fas fa-file-csv"></i> Export CSV
                    </button>
                    <button type="button" class="btn btn-info btn-sm me-2" onclick="exportResults('excel')">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="saveReport()">
                        <i class="fas fa-save"></i> Save Report
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <div id="resultsTable"></div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Buttons -->
<div class="action-buttons">
    <button type="button" class="floating-btn btn-next" id="nextBtn" onclick="nextStep()">
        Next <i class="fas fa-arrow-right"></i>
    </button>
    <button type="button" class="floating-btn btn-execute" id="executeBtn" onclick="executeReport()" style="display: none;">
        <i class="fas fa-play"></i> Generate Report
    </button>
</div>

<script>
let currentStep = 1;
let maxSteps = 4;
let selectedTemplate = null;
let selectedTable = null;
let selectedColumns = [];
let filters = [];
let reportConfig = {};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateProgressBar();
});

function updateProgressBar() {
    const progress = (currentStep / maxSteps) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
}

function goToStep(step) {
    if (step <= currentStep || step === 1) {
        currentStep = step;
        
        // Update step indicator
        for (let i = 1; i <= maxSteps; i++) {
            const stepEl = document.getElementById(`step-${i}`);
            const contentEl = document.getElementById(`content-${i}`);
            
            stepEl.classList.remove('active', 'completed');
            contentEl.classList.remove('active');
            
            if (i < currentStep) {
                stepEl.classList.add('completed');
            } else if (i === currentStep) {
                stepEl.classList.add('active');
                contentEl.classList.add('active');
            }
        }
        
        updateNavigationButtons();
        updateProgressBar();
    }
}

function nextStep() {
    if (validateCurrentStep()) {
        if (currentStep < maxSteps) {
            currentStep++;
            goToStep(currentStep);
        }
    }
}

function validateCurrentStep() {
    switch (currentStep) {
        case 1:
            if (!selectedTemplate) {
                alert('Please select a template to continue.');
                return false;
            }
            break;
        case 2:
            if (!selectedTable) {
                alert('Please select a data source to continue.');
                return false;
            }
            break;
        case 3:
            if (selectedColumns.length === 0) {
                alert('Please select at least one column to continue.');
                return false;
            }
            break;
    }
    return true;
}

function updateNavigationButtons() {
    const nextBtn = document.getElementById('nextBtn');
    const executeBtn = document.getElementById('executeBtn');
    
    if (currentStep === maxSteps) {
        nextBtn.style.display = 'none';
        executeBtn.style.display = 'block';
    } else {
        nextBtn.style.display = 'block';
        executeBtn.style.display = 'none';
    }
}

function selectTemplate(template) {
    selectedTemplate = template;
    
    // Update UI
    document.querySelectorAll('.template-card').forEach(card => {
        card.classList.remove('selected');
    });
    event.target.closest('.template-card').classList.add('selected');
    
    // Apply template presets
    applyTemplatePresets(template);
}

function applyTemplatePresets(template) {
    switch (template) {
        case 'workorders':
            selectedTable = 'workorders';
            selectedColumns = [
                {name: 'title', display_name: 'Title', type: 'VARCHAR'},
                {name: 'status', display_name: 'Status', type: 'VARCHAR'},
                {name: 'priority', display_name: 'Priority', type: 'VARCHAR'},
                {name: 'assigned_to', display_name: 'Assigned To', type: 'VARCHAR'},
                {name: 'created_at', display_name: 'Created Date', type: 'DATETIME'}
            ];
            break;
        case 'products':
            selectedTable = 'products';
            selectedColumns = [
                {name: 'product_name', display_name: 'Product Name', type: 'VARCHAR'},
                {name: 'model', display_name: 'Model', type: 'VARCHAR'},
                {name: 'serial_number', display_name: 'Serial Number', type: 'VARCHAR'},
                {name: 'status', display_name: 'Status', type: 'VARCHAR'}
            ];
            break;
        case 'users':
            selectedTable = 'users';
            selectedColumns = [
                {name: 'username', display_name: 'Username', type: 'VARCHAR'},
                {name: 'email', display_name: 'Email', type: 'VARCHAR'},
                {name: 'first_name', display_name: 'First Name', type: 'VARCHAR'},
                {name: 'last_name', display_name: 'Last Name', type: 'VARCHAR'},
                {name: 'created_at', display_name: 'Created Date', type: 'DATETIME'}
            ];
            break;
        case 'custom':
            // Reset for custom
            selectedTable = null;
            selectedColumns = [];
            break;
    }
}

function selectTable(tableName, displayName) {
    selectedTable = tableName;
    
    // Update UI
    document.querySelectorAll('.table-card').forEach(card => {
        card.classList.remove('selected');
    });
    event.target.closest('.table-card').classList.add('selected');
    
    // Load columns for this table
    loadTableColumns(tableName);
}

function loadTableColumns(tableName) {
    fetch(`/reporting/api/table/${tableName}/columns`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateAvailableColumns(data.columns);
                updateSelectedColumns();
            }
        })
        .catch(error => {
            console.error('Error loading columns:', error);
        });
}

function updateAvailableColumns(columns) {
    const container = document.getElementById('availableColumnsList');
    container.innerHTML = '';
    
    columns.forEach(column => {
        const isSelected = selectedColumns.find(col => col.name === column.name);
        const columnEl = document.createElement('div');
        columnEl.className = `column-item ${isSelected ? 'in-selected' : ''}`;
        columnEl.innerHTML = `
            <div>
                <strong>${column.display_name}</strong>
                <br><small class="text-muted">${column.type}</small>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addColumn('${column.name}', '${column.display_name}', '${column.type}')">
                <i class="fas fa-plus"></i>
            </button>
        `;
        container.appendChild(columnEl);
    });
}

function updateSelectedColumns() {
    const container = document.getElementById('selectedColumnsList');
    
    if (selectedColumns.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No columns selected yet</p>';
        return;
    }
    
    container.innerHTML = '';
    selectedColumns.forEach((column, index) => {
        const columnEl = document.createElement('div');
        columnEl.className = 'selected-column-item';
        columnEl.innerHTML = `
            <div>
                <strong>${column.display_name}</strong>
                <br><small class="text-muted">${column.type}</small>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeColumn(${index})">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(columnEl);
    });
    
    updateQueryPreview();
}

function addColumn(name, displayName, type) {
    if (!selectedColumns.find(col => col.name === name)) {
        selectedColumns.push({
            name: name,
            display_name: displayName,
            type: type
        });
        updateSelectedColumns();
        updateAvailableColumns([]); // Refresh to update selected state
        loadTableColumns(selectedTable); // Reload columns to update UI
    }
}

function removeColumn(index) {
    selectedColumns.splice(index, 1);
    updateSelectedColumns();
    loadTableColumns(selectedTable); // Reload to update available columns UI
}

function addFilter() {
    const filterIndex = filters.length;
    const filterEl = document.createElement('div');
    filterEl.className = 'filter-row';
    filterEl.innerHTML = `
        <select class="form-select" onchange="updateQueryPreview()">
            <option value="">Select Column</option>
            ${selectedColumns.map(col => `<option value="${col.name}">${col.display_name}</option>`).join('')}
        </select>
        <select class="form-select" onchange="updateQueryPreview()">
            <option value="eq">Equals</option>
            <option value="ne">Not Equals</option>
            <option value="gt">Greater Than</option>
            <option value="lt">Less Than</option>
            <option value="like">Contains</option>
            <option value="starts_with">Starts With</option>
            <option value="ends_with">Ends With</option>
        </select>
        <input type="text" class="form-control" placeholder="Value" onchange="updateQueryPreview()">
        <button type="button" class="btn btn-danger btn-sm" onclick="removeFilter(${filterIndex})">
            <i class="fas fa-trash"></i>
        </button>
    `;
    
    const container = document.getElementById('filtersList');
    if (container.querySelector('p')) {
        container.innerHTML = '';
    }
    container.appendChild(filterEl);
    
    filters.push({});
    updateQueryPreview();
}

function removeFilter(index) {
    filters.splice(index, 1);
    const container = document.getElementById('filtersList');
    container.children[index].remove();
    
    if (filters.length === 0) {
        container.innerHTML = '<p class="text-muted text-center py-3">No filters added yet. Click "Add Filter" to get started.</p>';
    }
    
    updateQueryPreview();
}

function updateQueryPreview() {
    if (!selectedTable || selectedColumns.length === 0) {
        document.getElementById('queryPreview').innerHTML = '<p class="text-muted">Your SQL query will appear here</p>';
        return;
    }
    
    const columns = selectedColumns.map(col => col.name).join(', ');
    const query = `SELECT ${columns} FROM ${selectedTable}`;
    
    document.getElementById('queryPreview').innerHTML = `<code>${query}</code>`;
}

function executeReport() {
    if (!validateCurrentStep()) return;
    
    // Build configuration
    reportConfig = {
        primary_table: selectedTable,
        columns: selectedColumns,
        filters: filters,
        sorting: {}
    };
    
    // Show loading
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    // Execute report
    fetch('/reporting/api/execute', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(reportConfig)
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingOverlay').style.display = 'none';
        
        if (data.success) {
            displayResults(data);
        } else {
            alert('Error executing report: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        document.getElementById('loadingOverlay').style.display = 'none';
        console.error('Error:', error);
        alert('Error executing report: ' + error.message);
    });
}

function displayResults(data) {
    const container = document.getElementById('resultsContainer');
    const tableContainer = document.getElementById('resultsTable');
    const countBadge = document.getElementById('resultCount');
    
    // Update count
    countBadge.textContent = `${data.data.length} records`;
    
    // Create table
    if (data.data.length > 0) {
        const headers = Object.keys(data.data[0]);
        let tableHTML = '<table class="table table-striped table-hover"><thead class="table-dark"><tr>';
        
        headers.forEach(header => {
            tableHTML += `<th>${header}</th>`;
        });
        tableHTML += '</tr></thead><tbody>';
        
        data.data.forEach(row => {
            tableHTML += '<tr>';
            headers.forEach(header => {
                tableHTML += `<td>${row[header] || ''}</td>`;
            });
            tableHTML += '</tr>';
        });
        
        tableHTML += '</tbody></table>';
        tableContainer.innerHTML = tableHTML;
    } else {
        tableContainer.innerHTML = '<p class="text-muted text-center py-3">No data found matching your criteria.</p>';
    }
    
    // Show results
    container.style.display = 'block';
    container.scrollIntoView({ behavior: 'smooth' });
}

function exportResults(format) {
    if (!reportConfig.primary_table) {
        alert('No report data to export');
        return;
    }
    
    const exportUrl = `/reporting/export/${format}`;
    
    fetch(exportUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(reportConfig)
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Export failed');
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `report.${format}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
    })
    .catch(error => {
        alert('Error exporting report: ' + error.message);
    });
}

function saveReport() {
    if (!reportConfig.primary_table) {
        alert('No report to save');
        return;
    }
    
    const name = prompt('Enter a name for this report:');
    if (!name) return;
    
    const saveData = {
        name: name,
        description: `Report generated on ${new Date().toLocaleDateString()}`,
        config: reportConfig
    };
    
    fetch('/reporting/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(saveData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Report saved successfully!');
        } else {
            alert('Error saving report: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error saving report: ' + error.message);
    });
}

function showHelp() {
    alert('Report Builder Help:\n\n1. Choose a template or start custom\n2. Select your data source\n3. Pick columns to include\n4. Add filters (optional)\n5. Generate your report!');
}

function loadSavedReport() {
    window.location.href = '/reporting/saved';
}
</script>

{% endblock %}
