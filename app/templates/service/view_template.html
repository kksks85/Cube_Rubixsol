{% extends "base.html" %}

{% block title %}View Template - {{ template.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-file-alt me-2"></i>{{ template.name }}</h2>
                    <p class="text-muted mb-0">Service Template Details</p>
                </div>
                <div>
                    <a href="{{ url_for('service.edit_template', id=template.id) }}" class="btn btn-primary">
                        <i class="fas fa-edit me-1"></i>Edit Template
                    </a>
                    <a href="{{ url_for('service.templates') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Templates
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Template Information -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Template Information</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Template Type:</strong>
                            <span class="badge bg-{{ 'success' if template.template_type == 'MAINTENANCE' else 'primary' if template.template_type == 'REPAIR' else 'warning' if template.template_type == 'INSPECTION' else 'info' }} ms-2">
                                {{ template.template_type }}
                            </span>
                        </div>
                        <div class="col-md-6">
                            <strong>Estimated Time:</strong>
                            <span class="text-primary">{{ template.estimated_time or 'Not specified' }}{% if template.estimated_time %} hours{% endif %}</span>
                        </div>
                    </div>
                    
                    {% if template.description %}
                    <div class="mb-3">
                        <strong>Description:</strong>
                        <p class="text-muted mt-1">{{ template.description }}</p>
                    </div>
                    {% endif %}
                    
                    {% if template.applicable_models %}
                    <div class="mb-3">
                        <strong>Applicable Models:</strong>
                        <p class="text-muted mt-1">{{ template.applicable_models }}</p>
                    </div>
                    {% endif %}
                    
                    {% if template.category %}
                    <div class="mb-3">
                        <strong>Category:</strong>
                        <span class="badge bg-outline-secondary">{{ template.category.name }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Procedure Steps -->
            {% if template.procedure_steps %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list-ol me-2"></i>Procedure Steps</h5>
                </div>
                <div class="card-body">
                    <div class="procedure-steps">
                        {% set steps = template.procedure_steps.split('\n') %}
                        {% for step in steps %}
                        {% if step.strip() %}
                        <div class="d-flex mb-2">
                            <div class="flex-shrink-0">
                                <span class="badge bg-primary rounded-circle me-3">{{ loop.index }}</span>
                            </div>
                            <div class="flex-grow-1">
                                <p class="mb-0">{{ step.strip() }}</p>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Required Tools -->
            {% if template.required_tools %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Required Tools</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% set tools = template.required_tools.split(',') %}
                        {% for tool in tools %}
                        {% if tool.strip() %}
                        <div class="col-md-6 mb-2">
                            <i class="fas fa-wrench text-muted me-2"></i>{{ tool.strip() }}
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Safety Notes -->
            {% if template.safety_notes %}
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Safety Notes</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning mb-0">
                        {{ template.safety_notes }}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Template Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('service.create_incident') }}?template_id={{ template.id }}" class="btn btn-success">
                            <i class="fas fa-play me-1"></i>Use This Template
                        </a>
                        <a href="{{ url_for('service.edit_template', id=template.id) }}" class="btn btn-primary">
                            <i class="fas fa-edit me-1"></i>Edit Template
                        </a>
                        <button class="btn btn-outline-secondary" onclick="duplicateTemplate({{ template.id }})">
                            <i class="fas fa-copy me-1"></i>Duplicate Template
                        </button>
                        <hr>
                        <button class="btn btn-outline-danger" onclick="deleteTemplate({{ template.id }})">
                            <i class="fas fa-trash me-1"></i>Delete Template
                        </button>
                    </div>
                </div>
            </div>

            <!-- Template Metadata -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info me-2"></i>Template Details</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-6 text-muted">Created:</div>
                        <div class="col-6">{{ template.created_at.strftime('%Y-%m-%d') }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6 text-muted">Updated:</div>
                        <div class="col-6">{{ template.updated_at.strftime('%Y-%m-%d') }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6 text-muted">Created by:</div>
                        <div class="col-6">{{ template.creator.username if template.creator else 'Unknown' }}</div>
                    </div>
                    <div class="row">
                        <div class="col-6 text-muted">Template ID:</div>
                        <div class="col-6">#{{ template.id }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function duplicateTemplate(templateId) {
    if (confirm('Create a copy of this template?')) {
        fetch(`/service/templates/${templateId}/duplicate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = `/service/templates/${data.new_template_id}/edit`;
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while duplicating the template.');
        });
    }
}

function deleteTemplate(templateId) {
    if (confirm('Are you sure you want to delete this template? This action cannot be undone.')) {
        fetch(`/service/templates/${templateId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/service/templates';
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the template.');
        });
    }
}
</script>

<style>
.procedure-steps .badge {
    min-width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.card-header.bg-warning {
    border-bottom: 1px solid #f0ad4e;
}

.alert-warning {
    border-left: 4px solid #f0ad4e;
}
</style>
{% endblock %}
