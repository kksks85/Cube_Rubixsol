{% extends "base.html" %}

{% block title %}Create Service Template{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-plus me-2"></i>Create Service Template</h2>
                    <p class="text-muted mb-0">Create standardized service procedure templates</p>
                </div>
                <div>
                    <a href="{{ url_for('service.templates') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Templates
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Creation Form -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Template Details</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}

                        <!-- Basic Information -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                {{ form.name.label(class="form-label fw-medium") }}
                                {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else "")) }}
                                {% if form.name.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.name.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                {{ form.category_id.label(class="form-label fw-medium") }}
                                {{ form.category_id(class="form-select" + (" is-invalid" if form.category_id.errors else "")) }}
                                {% if form.category_id.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.category_id.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                {{ form.description.label(class="form-label fw-medium") }}
                                {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), rows="3") }}
                                {% if form.description.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.description.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Template Type and Settings -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                {{ form.template_type.label(class="form-label fw-medium") }}
                                {{ form.template_type(class="form-select" + (" is-invalid" if form.template_type.errors else "")) }}
                                {% if form.template_type.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.template_type.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                {{ form.estimated_time.label(class="form-label fw-medium") }}
                                <div class="input-group">
                                    {{ form.estimated_time(class="form-control" + (" is-invalid" if form.estimated_time.errors else "")) }}
                                    <span class="input-group-text">hours</span>
                                </div>
                                {% if form.estimated_time.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.estimated_time.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Procedure Steps -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                {{ form.procedure_steps.label(class="form-label fw-medium") }}
                                {{ form.procedure_steps(class="form-control" + (" is-invalid" if form.procedure_steps.errors else ""), rows="6") }}
                                {% if form.procedure_steps.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.procedure_steps.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                                <div class="form-text">Enter each step on a new line or use numbered format</div>
                            </div>
                        </div>

                        <!-- Required Tools -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                {{ form.required_tools.label(class="form-label fw-medium") }}
                                {{ form.required_tools(class="form-control" + (" is-invalid" if form.required_tools.errors else ""), rows="3") }}
                                {% if form.required_tools.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.required_tools.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                                <div class="form-text">List required tools, one per line or comma-separated</div>
                            </div>
                        </div>

                        <!-- Required Tools -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                {{ form.required_tools.label(class="form-label fw-medium") }}
                                {{ form.required_tools(class="form-control" + (" is-invalid" if form.required_tools.errors else ""), rows="3") }}
                                {% if form.required_tools.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.required_tools.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                                <div class="form-text">List required tools and equipment</div>
                            </div>
                        </div>

                        <!-- Safety Notes -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                {{ form.safety_notes.label(class="form-label fw-medium") }}
                                {{ form.safety_notes(class="form-control" + (" is-invalid" if form.safety_notes.errors else ""), rows="3") }}
                                {% if form.safety_notes.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.safety_notes.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                                <div class="form-text">Important safety considerations and warnings</div>
                            </div>
                        </div>

                        <!-- Applicable Models -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                {{ form.applicable_models.label(class="form-label fw-medium") }}
                                {{ form.applicable_models(class="form-control" + (" is-invalid" if form.applicable_models.errors else ""), rows="2") }}
                                {% if form.applicable_models.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.applicable_models.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                                <div class="form-text">UAV models this template applies to</div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="row">
                            <div class="col-md-12">
                                <div class="d-flex justify-content-between">
                                    {{ form.submit(class="btn btn-primary") }}
                                    <a href="{{ url_for('service.templates') }}" class="btn btn-outline-secondary">Cancel</a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Template Preview -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-eye me-2"></i>Template Preview</h5>
                </div>
                <div class="card-body">
                    <div id="template-preview">
                        <div class="text-muted text-center py-4">
                            <i class="fas fa-file-alt fa-3x mb-3"></i>
                            <p>Fill in the form to see a preview of your template</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Template Guidelines -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Template Guidelines</h5>
                </div>
                <div class="card-body">
                    <h6>Best Practices:</h6>
                    <ul class="small">
                        <li>Use clear, step-by-step instructions</li>
                        <li>Include specific part numbers when possible</li>
                        <li>Mention safety precautions upfront</li>
                        <li>Specify required tools and equipment</li>
                        <li>Include quality check steps</li>
                        <li>Be specific about applicable UAV models</li>
                    </ul>

                    <h6 class="mt-3">Template Types:</h6>
                    <ul class="small">
                        <li><strong>Standard:</strong> General maintenance procedures</li>
                        <li><strong>Repair:</strong> Specific component repair steps</li>
                        <li><strong>Inspection:</strong> Safety and compliance checks</li>
                        <li><strong>Calibration:</strong> Sensor and system calibration</li>
                        <li><strong>Upgrade:</strong> Hardware/software upgrade procedures</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Template preview functionality
    const form = document.querySelector('form');
    const preview = document.getElementById('template-preview');
    
    function updatePreview() {
        const name = document.getElementById('name').value;
        const description = document.getElementById('description').value;
        const templateType = document.getElementById('template_type').value;
        const duration = document.getElementById('estimated_time').value;
        const steps = document.getElementById('procedure_steps').value;
        const parts = document.getElementById('required_tools').value;
        const tools = document.getElementById('required_tools').value;
        const safety = document.getElementById('safety_notes').value;
        const models = document.getElementById('applicable_models').value;
        
        if (!name && !description && !steps) {
            preview.innerHTML = `
                <div class="text-muted text-center py-4">
                    <i class="fas fa-file-alt fa-3x mb-3"></i>
                    <p>Fill in the form to see a preview of your template</p>
                </div>
            `;
            return;
        }
        
        let previewHtml = `
            <div class="template-preview">
                ${name ? `<h6 class="fw-bold">${name}</h6>` : ''}
                ${templateType ? `<span class="badge bg-info mb-2">${templateType}</span>` : ''}
                ${duration ? `<span class="badge bg-secondary mb-2 ms-1">${duration} hours</span>` : ''}
                ${description ? `<p class="text-muted small">${description}</p>` : ''}
                
                ${safety ? `
                <div class="alert alert-warning py-2">
                    <h6 class="small fw-bold mb-1"><i class="fas fa-exclamation-triangle me-1"></i>Safety Notes:</h6>
                    <p class="small mb-0">${safety}</p>
                </div>
                ` : ''}
                
                ${steps ? `
                <div class="mb-3">
                    <h6 class="small fw-bold">Procedure Steps:</h6>
                    <div class="small">${steps.split('\\n').map((step, index) => `<div class="mb-1">${index + 1}. ${step}</div>`).join('')}</div>
                </div>
                ` : ''}
                
                ${parts ? `
                <div class="mb-3">
                    <h6 class="small fw-bold">Required Parts:</h6>
                    <p class="small text-muted">${parts}</p>
                </div>
                ` : ''}
                
                ${tools ? `
                <div class="mb-3">
                    <h6 class="small fw-bold">Required Tools:</h6>
                    <p class="small text-muted">${tools}</p>
                </div>
                ` : ''}
                
                ${models ? `
                <div class="mb-3">
                    <h6 class="small fw-bold">Applicable Models:</h6>
                    <p class="small text-muted">${models}</p>
                </div>
                ` : ''}
            </div>
        `;
        
        preview.innerHTML = previewHtml;
    }
    
    // Add event listeners to form fields
    form.addEventListener('input', updatePreview);
    form.addEventListener('change', updatePreview);
});
</script>

<style>
.template-preview {
    font-size: 0.875rem;
}

.template-preview h6 {
    color: #495057;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 0.25rem;
}

.form-label.fw-medium {
    font-weight: 500;
    color: #495057;
}

.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.alert-warning {
    background-color: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
}
</style>
{% endblock %}
