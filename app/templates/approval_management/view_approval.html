{% extends "base.html" %}
{% set active_page = "approval_management" %}

{% block title %}Approval Details - {{ approval.incident.incident_number_formatted }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('approval_management.dashboard') }}">Approval Management</a></li>
                <li class="breadcrumb-item active">Approval Details</li>
            </ol>
        </nav>
        <h2><i class="fas fa-eye me-2"></i>Approval Details</h2>
        <p class="text-muted">Work order approval information for incident {{ approval.incident.incident_number_formatted }}</p>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Approval Status -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-clipboard-check me-2"></i>Approval Status
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Status:</strong><br>
                            {% if approval.is_pending %}
                                <span class="badge badge-warning badge-lg">Pending</span>
                            {% elif approval.is_approved %}
                                <span class="badge badge-success badge-lg">Approved</span>
                            {% else %}
                                <span class="badge badge-danger badge-lg">Rejected</span>
                            {% endif %}
                        </p>
                        
                        {% if approval.approved_at %}
                        <p><strong>{{ 'Approved' if approval.is_approved else 'Rejected' }} Date:</strong><br>
                            {{ approval.approved_at.strftime('%Y-%m-%d %H:%M:%S') }}
                        </p>
                        {% endif %}
                        
                        {% if approval.is_pending %}
                        <p><strong>Days Pending:</strong><br>
                            <span class="{% if approval.days_pending > 5 %}text-danger{% elif approval.days_pending > 2 %}text-warning{% endif %}">
                                {{ approval.days_pending }} day{% if approval.days_pending != 1 %}s{% endif %}
                            </span>
                        </p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <p><strong>Approver:</strong><br>{{ approval.approver.full_name }}</p>
                        <p><strong>Requested By:</strong><br>{{ approval.requester.full_name }}</p>
                        <p><strong>Request Date:</strong><br>{{ approval.requested_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                    </div>
                </div>
                
                {% if approval.approval_comments %}
                <div class="mt-3">
                    <p><strong>{{ 'Approval' if approval.is_approved else 'Rejection' }} Comments:</strong></p>
                    <div class="p-3 {% if approval.is_approved %}bg-success{% else %}bg-danger{% endif %} bg-opacity-10 rounded">
                        {{ approval.approval_comments }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Incident Details -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-secondary">
                    <i class="fas fa-info-circle me-2"></i>Related Incident Details
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Incident Number:</strong><br>
                            <a href="{{ url_for('uav_service.view_incident', id=approval.incident.id) }}" class="text-decoration-none">
                                {{ approval.incident.incident_number_formatted }}
                            </a>
                        </p>
                        <p><strong>Title:</strong><br>{{ approval.incident.title }}</p>
                        <p><strong>Priority:</strong><br>
                            {% if approval.incident.priority == 'URGENT' %}
                                <span class="badge badge-danger">{{ approval.incident.priority }}</span>
                            {% elif approval.incident.priority == 'HIGH' %}
                                <span class="badge badge-warning">{{ approval.incident.priority }}</span>
                            {% elif approval.incident.priority == 'MEDIUM' %}
                                <span class="badge badge-primary">{{ approval.incident.priority }}</span>
                            {% else %}
                                <span class="badge badge-secondary">{{ approval.incident.priority }}</span>
                            {% endif %}
                        </p>
                        <p><strong>Customer:</strong><br>{{ approval.incident.customer_name }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Category:</strong><br>{{ approval.incident.incident_category.replace('_', ' ').title() }}</p>
                        <p><strong>Current Status:</strong><br>{{ approval.incident.workflow_step_info.name }}</p>
                        <p><strong>Progress:</strong><br>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: {{ approval.incident.workflow_progress_percentage }}%"
                                     aria-valuenow="{{ approval.incident.workflow_progress_percentage }}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                    {{ approval.incident.workflow_progress_percentage|round|int }}%
                                </div>
                            </div>
                        </p>
                        <p><strong>Created:</strong><br>{{ approval.incident.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Request Details -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-info">
                    <i class="fas fa-clipboard-list me-2"></i>Request Details
                </h6>
            </div>
            <div class="card-body">
                <p><strong>Approval Type:</strong><br>{{ approval.approval_type.replace('_', ' ').title() }}</p>
                
                {% if approval.estimated_cost %}
                <p><strong>Estimated Cost:</strong><br>${{ approval.estimated_cost }}</p>
                {% endif %}
                
                {% if approval.estimated_hours %}
                <p><strong>Estimated Hours:</strong><br>{{ approval.estimated_hours }} hours</p>
                {% endif %}
                
                {% if approval.request_details %}
                <p><strong>Additional Details:</strong></p>
                <div class="p-2 bg-light rounded small">
                    {{ approval.request_details }}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Email Tracking -->
        {% if approval.email_sent_at %}
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-secondary">
                    <i class="fas fa-envelope me-2"></i>Email Tracking
                </h6>
            </div>
            <div class="card-body">
                <p><strong>Email Sent:</strong><br>
                    <i class="fas fa-check text-success"></i> {{ approval.email_sent_at.strftime('%Y-%m-%d %H:%M:%S') }}
                </p>
                
                {% if approval.email_opened_at %}
                <p><strong>Email Opened:</strong><br>
                    <i class="fas fa-check text-success"></i> {{ approval.email_opened_at.strftime('%Y-%m-%d %H:%M:%S') }}
                </p>
                {% else %}
                <p><strong>Email Opened:</strong><br>
                    <i class="fas fa-times text-muted"></i> Not opened yet
                </p>
                {% endif %}
                
                {% if approval.email_clicked_at %}
                <p><strong>Email Clicked:</strong><br>
                    <i class="fas fa-check text-success"></i> {{ approval.email_clicked_at.strftime('%Y-%m-%d %H:%M:%S') }}
                </p>
                {% else %}
                <p><strong>Email Clicked:</strong><br>
                    <i class="fas fa-times text-muted"></i> Not clicked yet
                </p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Actions -->
        {% if approval.is_pending and (approval.approver_id == current_user.id or current_user.has_role('admin')) %}
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-cogs me-2"></i>Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-success" onclick="approveRequest({{ approval.id }})">
                        <i class="fas fa-check me-2"></i>Approve
                    </button>
                    <button type="button" class="btn btn-danger" onclick="rejectRequest({{ approval.id }})">
                        <i class="fas fa-times me-2"></i>Reject
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Approval Modal -->
<div class="modal fade" id="approvalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Process Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="approvalForm" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="comments" class="form-label">Comments <span id="required-indicator" style="display:none;" class="text-danger">*</span></label>
                        <textarea class="form-control" id="comments" name="comments" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn" id="submitBtn">Confirm</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function approveRequest(approvalId) {
    $('#modalTitle').text('Approve Work Order');
    $('#approvalForm').attr('action', `/approval-management/approve/${approvalId}`);
    $('#submitBtn').removeClass('btn-danger').addClass('btn-success').text('Approve');
    $('#required-indicator').hide();
    $('#comments').attr('placeholder', 'Enter approval comments (optional)');
    $('#approvalModal').modal('show');
}

function rejectRequest(approvalId) {
    $('#modalTitle').text('Reject Work Order');
    $('#approvalForm').attr('action', `/approval-management/reject/${approvalId}`);
    $('#submitBtn').removeClass('btn-success').addClass('btn-danger').text('Reject');
    $('#required-indicator').show();
    $('#comments').attr('placeholder', 'Enter rejection reason (required)');
    $('#approvalModal').modal('show');
}

// Form validation for rejection
$('#approvalForm').on('submit', function(e) {
    if ($('#submitBtn').hasClass('btn-danger')) {
        if (!$('#comments').val().trim()) {
            e.preventDefault();
            alert('Please provide comments for rejection.');
            $('#comments').focus();
        }
    }
});
</script>
{% endblock %}
