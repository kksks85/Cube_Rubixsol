{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-header p-4 rounded-3 position-relative overflow-hidden" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); color: white;">
                <div class="position-relative z-index-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="display-6 fw-bold mb-2 animate__animated animate__fadeInLeft">
                                <i class="fas fa-users me-3"></i>User Management
                            </h1>
                            <p class="lead mb-0 animate__animated animate__fadeInLeft" style="animation-delay: 0.2s;">
                                Comprehensive user administration and management system
                            </p>
                        </div>
                        <div class="animate__animated animate__fadeInRight">
                            <button class="btn btn-light btn-lg shadow-sm me-2" id="toggleSidebar">
                                <i class="fas fa-bars me-2"></i>Menu
                            </button>
                            <a href="{{ url_for('users.create_user') }}" class="btn btn-success btn-lg shadow-sm">
                                <i class="fas fa-user-plus me-2"></i>Add User
                            </a>
                        </div>
                    </div>
                </div>
                <div class="position-absolute top-0 end-0 w-100 h-100 opacity-10">
                    <i class="fas fa-users" style="font-size: 15rem; color: white; position: absolute; top: -2rem; right: -5rem; transform: rotate(15deg);"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Collapsible Sidebar -->
        <div class="col-lg-3 mb-4" id="userManagementSidebar">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>Management Tools
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="accordion" id="userManagementAccordion">
                        
                        <!-- User Operations -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="userOpsHeading">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#userOpsCollapse" aria-expanded="true" aria-controls="userOpsCollapse">
                                    <i class="fas fa-user-cog me-2"></i>User Operations
                                </button>
                            </h2>
                            <div id="userOpsCollapse" class="accordion-collapse collapse show" aria-labelledby="userOpsHeading">
                                <div class="accordion-body p-0">
                                    <div class="list-group list-group-flush">
                                        <a href="{{ url_for('users.list_users') }}" class="list-group-item list-group-item-action d-flex align-items-center">
                                            <i class="fas fa-list me-3 text-primary"></i>All Users
                                        </a>
                                        <a href="{{ url_for('users.create_user') }}" class="list-group-item list-group-item-action d-flex align-items-center">
                                            <i class="fas fa-user-plus me-3 text-success"></i>Add New User
                                        </a>
                                        <a href="#" onclick="filterUsers('active')" class="list-group-item list-group-item-action d-flex align-items-center">
                                            <i class="fas fa-user-check me-3 text-success"></i>Active Users
                                        </a>
                                        <a href="#" onclick="filterUsers('inactive')" class="list-group-item list-group-item-action d-flex align-items-center">
                                            <i class="fas fa-user-times me-3 text-warning"></i>Inactive Users
                                        </a>
                                        <a href="#" onclick="filterUsers('recent')" class="list-group-item list-group-item-action d-flex align-items-center">
                                            <i class="fas fa-clock me-3 text-info"></i>Recently Added
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Role Management -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="roleManagementHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#roleManagementCollapse" aria-expanded="false" aria-controls="roleManagementCollapse">
                                    <i class="fas fa-user-tag me-2"></i>Role Management
                                </button>
                            </h2>
                            <div id="roleManagementCollapse" class="accordion-collapse collapse" aria-labelledby="roleManagementHeading">
                                <div class="accordion-body p-0">
                                    <div class="list-group list-group-flush">
                                        <a href="#" onclick="filterByRole('admin')" class="list-group-item list-group-item-action d-flex align-items-center">
                                            <i class="fas fa-crown me-3 text-danger"></i>Administrators
                                        </a>
                                        <a href="#" onclick="filterByRole('manager')" class="list-group-item list-group-item-action d-flex align-items-center">
                                            <i class="fas fa-users-cog me-3 text-warning"></i>Managers
                                        </a>
                                        <a href="#" onclick="filterByRole('technician')" class="list-group-item list-group-item-action d-flex align-items-center">
                                            <i class="fas fa-tools me-3 text-info"></i>Technicians
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center">
                                            <i class="fas fa-plus me-3 text-success"></i>Manage Roles
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bulk Operations -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="bulkOpsHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#bulkOpsCollapse" aria-expanded="false" aria-controls="bulkOpsCollapse">
                                    <i class="fas fa-tasks me-2"></i>Bulk Operations
                                </button>
                            </h2>
                            <div id="bulkOpsCollapse" class="accordion-collapse collapse" aria-labelledby="bulkOpsHeading">
                                <div class="accordion-body p-0">
                                    <div class="list-group list-group-flush">
                                        <a href="#" onclick="bulkAction('activate')" class="list-group-item list-group-item-action d-flex align-items-center">
                                            <i class="fas fa-user-check me-3 text-success"></i>Bulk Activate
                                        </a>
                                        <a href="#" onclick="bulkAction('deactivate')" class="list-group-item list-group-item-action d-flex align-items-center">
                                            <i class="fas fa-user-times me-3 text-warning"></i>Bulk Deactivate
                                        </a>
                                        <a href="#" onclick="bulkAction('reset_password')" class="list-group-item list-group-item-action d-flex align-items-center">
                                            <i class="fas fa-key me-3 text-info"></i>Reset Passwords
                                        </a>
                                        <a href="#" onclick="bulkAction('export')" class="list-group-item list-group-item-action d-flex align-items-center">
                                            <i class="fas fa-download me-3 text-primary"></i>Export Users
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Reports -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="reportsHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#reportsCollapse" aria-expanded="false" aria-controls="reportsCollapse">
                                    <i class="fas fa-chart-bar me-2"></i>Reports & Analytics
                                </button>
                            </h2>
                            <div id="reportsCollapse" class="accordion-collapse collapse" aria-labelledby="reportsHeading">
                                <div class="accordion-body p-0">
                                    <div class="list-group list-group-flush">
                                        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center">
                                            <i class="fas fa-chart-pie me-3 text-primary"></i>User Statistics
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center">
                                            <i class="fas fa-clock me-3 text-info"></i>Login Activity
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center">
                                            <i class="fas fa-tasks me-3 text-success"></i>Work Order Statistics
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center">
                                            <i class="fas fa-file-pdf me-3 text-danger"></i>Generate Report
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Quick Stats Card -->
            <div class="card shadow-sm mt-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Quick Stats
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h4 class="text-primary mb-0">{{ users.total if users else 0 }}</h4>
                                <small class="text-muted">Total Users</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success mb-0">{{ active_users_count|default(0) }}</h4>
                            <small class="text-muted">Active</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-4">
                            <h6 class="text-danger mb-0">{{ admin_count|default(0) }}</h6>
                            <small class="text-muted">Admins</small>
                        </div>
                        <div class="col-4">
                            <h6 class="text-warning mb-0">{{ manager_count|default(0) }}</h6>
                            <small class="text-muted">Managers</small>
                        </div>
                        <div class="col-4">
                            <h6 class="text-info mb-0">{{ tech_count|default(0) }}</h6>
                            <small class="text-muted">Techs</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="col-lg-9">
            <!-- Search and Filter Bar -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="userSearch" placeholder="Search users..." onkeyup="searchUsers()">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="roleFilter" onchange="filterUsers()">
                                <option value="">All Roles</option>
                                <option value="admin">Administrator</option>
                                <option value="manager">Manager</option>
                                <option value="technician">Technician</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="statusFilter" onchange="filterUsers()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>Users List
                    </h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="selectAll()">
                            <i class="fas fa-check-square"></i> Select All
                        </button>
                        <button class="btn btn-outline-secondary" onclick="deselectAll()">
                            <i class="fas fa-square"></i> Deselect All
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if users and users.items %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="usersTable">
                            <thead class="table-dark">
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                    </th>
                                    <th>User</th>
                                    <th>Contact</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Activity</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users.items %}
                                <tr class="{% if not user.is_active %}table-secondary{% endif %}" data-user-id="{{ user.id }}">
                                    <td>
                                        <input type="checkbox" class="user-checkbox" value="{{ user.id }}">
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-3">
                                                <i class="fas fa-user text-white"></i>
                                            </div>
                                            <div>
                                                <a href="{{ url_for('users.view_user', id=user.id) }}" class="text-decoration-none fw-semibold">
                                                    {{ user.full_name }}
                                                </a>
                                                <br>
                                                <small class="text-muted">@{{ user.username }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <i class="fas fa-envelope me-1 text-muted"></i>{{ user.email }}
                                        </div>
                                        {% if user.phone %}
                                        <div>
                                            <i class="fas fa-phone me-1 text-muted"></i>{{ user.phone }}
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if user.role.name == 'admin' %}danger{% elif user.role.name == 'manager' %}warning{% else %}info{% endif %}">
                                            {{ user.role.name.title() if user.role else 'User' }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if user.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {% if user.last_login %}
                                                Last: {{ user.last_login.strftime('%Y-%m-%d') }}
                                            {% else %}
                                                Never logged in
                                            {% endif %}
                                        </small>
                                        <br>
                                        <small class="text-muted">
                                            Created: {{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'Unknown' }}
                                        </small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('users.view_user', id=user.id) }}" class="btn btn-outline-primary" title="View">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if current_user.has_role('admin') %}
                                            <a href="{{ url_for('users.edit_user', id=user.id) }}" class="btn btn-outline-secondary" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button class="btn btn-outline-warning" onclick="resetPassword({{ user.id }})" title="Reset Password">
                                                <i class="fas fa-key"></i>
                                            </button>
                                            <button class="btn btn-outline-{% if user.is_active %}danger{% else %}success{% endif %}" onclick="toggleUserStatus({{ user.id }})" title="{% if user.is_active %}Deactivate{% else %}Activate{% endif %}">
                                                <i class="fas fa-{% if user.is_active %}user-times{% else %}user-check{% endif %}"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if users.pages > 1 %}
                    <div class="card-footer">
                        <nav aria-label="User pagination">
                            <ul class="pagination pagination-sm justify-content-center mb-0">
                                {% if users.has_prev %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('users.list_users', page=users.prev_num) }}">Previous</a>
                                    </li>
                                {% endif %}
                                
                                {% for page_num in users.iter_pages() %}
                                    {% if page_num %}
                                        {% if page_num != users.page %}
                                            <li class="page-item">
                                                <a class="page-link" href="{{ url_for('users.list_users', page=page_num) }}">{{ page_num }}</a>
                                            </li>
                                        {% else %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ page_num }}</span>
                                            </li>
                                        {% endif %}
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">...</span>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if users.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('users.list_users', page=users.next_num) }}">Next</a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                    
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No users found</h5>
                        <p class="text-muted">Start by creating your first user</p>
                        <a href="{{ url_for('users.create_user') }}" class="btn btn-primary">
                            <i class="fas fa-user-plus me-2"></i>Add First User
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.avatar-sm {
    width: 35px;
    height: 35px;
}

.page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
}

#userManagementSidebar {
    transition: all 0.3s ease;
    display: block !important;
}

.sidebar-collapsed {
    margin-left: -100%;
}

/* Desktop behavior - always visible */
@media (min-width: 992px) {
    #userManagementSidebar {
        display: block !important;
    }
}

/* Mobile behavior - toggle visibility */
@media (max-width: 991.98px) {
    #userManagementSidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100vh;
        z-index: 1050;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        display: none;
    }
    
    #userManagementSidebar.show {
        transform: translateX(0);
        display: block !important;
    }
}

/* Ensure accordion items are properly styled */
.accordion-button:not(.collapsed) {
    background-color: #e7f1ff;
    color: #0d6efd;
}

.accordion-button:focus {
    box-shadow: none;
    border-color: #86b7fe;
}

.list-group-item:hover {
    background-color: #f8f9fa;
}
</style>

<script>
// Ensure document is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('User Management: DOM loaded');
    
    // Initialize Bootstrap components
    var accordionElements = document.querySelectorAll('.accordion-button');
    accordionElements.forEach(function(element) {
        console.log('Found accordion button:', element);
    });
});

// Toggle sidebar
document.getElementById('toggleSidebar').addEventListener('click', function() {
    console.log('Toggle sidebar clicked');
    const sidebar = document.getElementById('userManagementSidebar');
    sidebar.classList.toggle('show');
    
    // For desktop, just toggle visibility
    if (window.innerWidth >= 992) {
        if (sidebar.style.display === 'none') {
            sidebar.style.display = 'block';
        } else {
            sidebar.style.display = 'none';
        }
    }
});

// Search functionality
function searchUsers() {
    const searchTerm = document.getElementById('userSearch').value.toLowerCase();
    const table = document.getElementById('usersTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let row of rows) {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    }
}

// Filter functions
function filterUsers(type) {
    console.log('Filtering users by:', type);
    // Implement filtering logic here
}

function filterByRole(role) {
    console.log('Filtering by role:', role);
    // Implement role filtering logic here
}

function clearFilters() {
    document.getElementById('userSearch').value = '';
    document.getElementById('roleFilter').value = '';
    document.getElementById('statusFilter').value = '';
    searchUsers();
}

// Bulk operations
function selectAll() {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    checkboxes.forEach(cb => cb.checked = true);
}

function deselectAll() {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    checkboxes.forEach(cb => cb.checked = false);
}

function toggleSelectAll() {
    const selectAllCb = document.getElementById('selectAllCheckbox');
    const checkboxes = document.querySelectorAll('.user-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAllCb.checked);
}

function bulkAction(action) {
    const selectedUsers = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.value);
    if (selectedUsers.length === 0) {
        alert('Please select users first');
        return;
    }
    
    if (confirm(`Are you sure you want to ${action} ${selectedUsers.length} user(s)?`)) {
        console.log(`Bulk ${action} for users:`, selectedUsers);
        // Implement bulk action logic here
    }
}

// Individual user actions
function resetPassword(userId) {
    if (confirm('Are you sure you want to reset this user\'s password?')) {
        fetch(`/users/${userId}/reset-password`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Password reset successfully');
                location.reload();
            } else {
                alert('Error resetting password');
            }
        });
    }
}

function toggleUserStatus(userId) {
    fetch(`/users/${userId}/toggle-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error updating user status');
        }
    });
}
</script>
{% endblock %}
