<!DOCTYPE html>
<html>
<head>
    <title>Add Filter Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Add Filter Test</h2>
        
        <div class="mb-3">
            <label for="dataSourceSelect" class="form-label">Select Table</label>
            <select class="form-select" id="dataSourceSelect">
                <option value="">Choose a table...</option>
                <option value="products">Products</option>
                <option value="users">Users</option>
                <option value="work_orders">Work Orders</option>
            </select>
        </div>
        
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">Filters</h6>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addFilter()">
                    <i class="fas fa-plus"></i> Add Filter
                </button>
            </div>
            <div class="card-body">
                <div id="filtersContainer">
                    <!-- Filters will be added dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let availableColumns = [
            {name: 'id', display_name: 'ID'},
            {name: 'name', display_name: 'Name'},
            {name: 'email', display_name: 'Email'},
            {name: 'created_at', display_name: 'Created At'}
        ];

        function addFilter(existingFilter = null) {
            console.log('addFilter called', existingFilter);
            
            const container = document.getElementById('filtersContainer');
            const dataSource = document.getElementById('dataSourceSelect').value;
            
            console.log('Data source:', dataSource);
            console.log('Available columns:', availableColumns);
            
            // Check if data source is selected
            if (!dataSource) {
                alert('Please select a data source first before adding filters.');
                return;
            }
            
            const filterId = 'filter_' + Date.now();
            
            const filterDiv = document.createElement('div');
            filterDiv.className = 'filter-item border rounded p-3 mb-3';
            filterDiv.id = filterId;
            
            try {
                filterDiv.innerHTML = `
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Field</label>
                            <select class="form-select filter-field">
                                <option value="">Select field...</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Operator</label>
                            <select class="form-select filter-operator">
                                <option value="equals">Equals</option>
                                <option value="not_equals">Not Equals</option>
                                <option value="contains">Contains</option>
                                <option value="starts_with">Starts With</option>
                                <option value="ends_with">Ends With</option>
                                <option value="greater_than">Greater Than</option>
                                <option value="less_than">Less Than</option>
                                <option value="is_null">Is Null</option>
                                <option value="is_not_null">Is Not Null</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Value</label>
                            <input type="text" class="form-control filter-value">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-danger btn-sm d-block" onclick="removeFilter('${filterId}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(filterDiv);
                console.log('Filter div added to container');
                
                // Populate field options
                if (availableColumns && availableColumns.length > 0) {
                    const fieldSelect = filterDiv.querySelector('.filter-field');
                    availableColumns.forEach(column => {
                        const option = document.createElement('option');
                        option.value = column.name;
                        option.textContent = column.display_name;
                        fieldSelect.appendChild(option);
                    });
                    console.log('Field options populated');
                }
                
            } catch (error) {
                console.error('Error in addFilter:', error);
                alert('Error adding filter: ' + error.message);
            }
        }

        function removeFilter(filterId) {
            console.log('removeFilter called for:', filterId);
            const element = document.getElementById(filterId);
            if (element) {
                element.remove();
                console.log('Filter removed');
            }
        }
    </script>
</body>
</html>
